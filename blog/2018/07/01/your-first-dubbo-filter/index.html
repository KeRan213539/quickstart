<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Your First Dubbo Filter</title><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en-us"><meta property="og:type" content="website"><meta property="og:site_name" content="Nacos"><meta property="og:title" content="Your First Dubbo Filter"><meta property="og:url" content="/blog/2018/07/01/your-first-dubbo-filter/"><meta property="og:image" content="/images/"><meta name=twitter:title content="Nacos"><meta name=twitter:url content="/blog/2018/07/01/your-first-dubbo-filter/"><meta name=twitter:image content="/images/"><meta name=twitter:card content><link rel=canonical href=/blog/2018/07/01/your-first-dubbo-filter/><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600,400italic,700" rel=stylesheet type=text/css><link rel=stylesheet href=/css/leaflet.css><link rel=stylesheet href=/css/animate.css><link rel=stylesheet href=/css/icomoon.css><link rel=stylesheet href=/css/simple-line-icons.css><link rel=stylesheet href=/css/magnific-popup.css><link rel=stylesheet href=/css/bootstrap.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/custom1.css><link rel=stylesheet href=/css/custom2.css><link rel=stylesheet href=/css/font-awesome.min.css><script src=/js/modernizr-2.6.2.min.js></script><meta name=referrer content="no-referrer"><link rel="shortcut icon" href=https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png><script src=/js/jquery.min.js></script><script src=/js/jquery.easing.1.3.js></script><script src=/js/bootstrap.min.js></script><script src=/js/jquery.waypoints.min.js></script><script src=/js/jquery.stellar.min.js></script><script src=/js/jquery.countTo.js></script><script src=/js/jquery.magnific-popup.min.js></script><script src=/js/magnific-popup-options.js></script><script src=/js/main.js></script></head><body><header role=banner id=fh5co-header><div class=container><nav class="navbar navbar-default"><div class=navbar-header><a href=# class="js-fh5co-nav-toggle fh5co-nav-toggle" data-toggle=collapse data-target=#navbar aria-expanded=false aria-controls=navbar><i></i></a><a class=navbar-brand href=index.html><img id=nacosLogo src=/images/nacos.png></a></div><div id=navbar class="navbar-collapse collapse"><ul class="nav navbar-nav navbar-right"><li><a class=external href=/><span>Home</span></a></li><li><a class=external href=/docs><span>Documentation</span></a></li><li class=active><a class=external href=/blog><span>Blog</span></a></li><li><a class=external href=/community><span>Community</span></a></li><li><a class=external href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0"><span>Naco In Cloud</span></a>
<img class=menu-img src=https://img.alicdn.com/tfs/TB1esl_m.T1gK0jSZFrXXcNCXXa-200-200.png></li><li><a class=external href=http://console.nacos.io/nacos/index.html><span>Demo-Console</span></a></li><li><div class=dropdown><button class="btn btn-default dropdown-toggle" type=button data-toggle=dropdown aria-haspopup=true aria-expanded=false>
English
<span class=caret></span></button><ul class=dropdown-menu><li><a class=external href=/zh/blog/2018/07/01/%E7%AC%AC%E4%B8%80%E4%B8%AA-dubbo-filter/>中文</a></li></ul></div></li><li><div class=navbar-nav><input type=search class="form-control nav-search-input" placeholder="&#xf002 Search this site…" aria-label="Search this site…" autocomplete=off>
<script src=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.js></script><link href=https://cdn.jsdelivr.net/npm/docsearch.js@2.6.3/dist/cdn/docsearch.min.css rel=stylesheet><script>docsearch({appId:"3CRHI0VEW6",apiKey:"e7b36bd85080f2bcfb9de34adc766043",indexName:"nacos_test",algoliaOptions:{hitsPerPage:3},inputSelector:'.nav-search-input',debug:false});</script></div></li></ul></div></nav></div></header><section class=animated><div class="col-md-2 blogDocSidebar"><a href=# id=sidebarConsoleBtn><i class="fa fa-bars fa-fw"></i></a><div id=sidebarContent><ul><li><a href=/blog/>Blog</a></li><ul><li class="collapse show" id=blog><ul><li><a class=active href=/blog/news/>Articles</a></li><ul><li class="collapse show" id=blognews><a id=m-blog20190826service-test href=/blog/2019/08/26/service-test/>Service test in dubbo admin</a>
<a id=m-blog20190811tracing-dubbo-service-with-apache-skywalking href=/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/>Use apache skywalking in dubbo</a>
<a id=m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2 href=/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/>Dubbo extensible mechanism - part 2</a>
<a id=m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1 href=/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/>Dubbo extensible mechanism - part 1</a>
<a id=m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/>Dubbo Async Client</a>
<a id=m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface href=/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/>Dubbo Async Server</a>
<a id=m-blog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices href=/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/>Use Seata in Dubbo</a>
<a id=m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou href=/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/>The fifth Dubbo meetup</a>
<a id=m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry href=/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/>Use Dubbo with Nacos</a>
<a id=m-blog20181005introduction-to-the-dubbo-protocol href=/blog/2018/10/05/introduction-to-the-dubbo-protocol/>Introduction to the Dubbo protocol</a>
<a id=m-blog20180930integrate-dubbo-with-kubernetes href=/blog/2018/09/30/integrate-dubbo-with-kubernetes/>Integrate Dubbo with Kubernetes</a>
<a id=m-blog20180902how-to-prepare-an-apache-release href=/blog/2018/09/02/how-to-prepare-an-apache-release/>How to prepare an Apache Release</a>
<a id=m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo href=/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/>New Async Call</a>
<a id=m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu href=/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/>The fourth Dubbo meetup</a>
<a id=m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/>Dubbo Consumer Configuration</a>
<a id=m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke href=/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/>Dubbo Invoke</a>
<a id=m-blog20180814dubbo-basic-usage-dubbo-provider-configuration href=/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/>Dubbo Provider Configuration</a>
<a id=m-blog20180814manipulating-services-dynamically-via-qos href=/blog/2018/08/14/manipulating-services-dynamically-via-qos/>Dubbo QoS Introduction</a>
<a id=m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop href=/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/>Dubbo start/stop in spring boot</a>
<a id=m-blog20180814implementation-of-cross-language-calls-by-dubbo2js href=/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/>dubbo2.js introduction</a>
<a id=m-blog20180814generic-invoke-of-dubbo href=/blog/2018/08/14/generic-invoke-of-dubbo/>Generic invoke</a>
<a id=m-blog20180810dubbos-load-balance href=/blog/2018/08/10/dubbos-load-balance/>Dubbo's Load Balance</a>
<a id=m-blog20180807use-annotations-in-dubbo href=/blog/2018/08/07/use-annotations-in-dubbo/>Use Annotations In Dubbo</a>
<a id=m-blog20180807using-zookeeper-in-dubbo href=/blog/2018/08/07/using-zookeeper-in-dubbo/>Using Zookeeper in Dubbo</a>
<a id=m-blog20180807dubbo-101 href=/blog/2018/08/07/dubbo-101/>Your First Dubbo Demo</a>
<a id=m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen href=/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/>The third Dubbo meetup</a>
<a id=m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services href=/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/>Introduce sentinel</a>
<a id=m-blog20180712tracking-with-pinpoint href=/blog/2018/07/12/tracking-with-pinpoint/>Tracking with Pinpoint</a>
<a id=m-blog20180701your-first-dubbo-filter class=active2 href=/blog/2018/07/01/your-first-dubbo-filter/>Your First Dubbo Filter</a>
<a id=m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully href=/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/>The second Dubbo meetup</a>
<a id=m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing href=/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/>The first Dubbo meetup</a>
<a id=m-blog20180502the-apachecon-na-schedule-has-been-announced href=/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/>ApacheCon NA</a>
<a id=m-blog20180425the-gsocgoogle-summer-of-code-2018 href=/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/>GSoC 2018</a>
<a id=m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018 href=/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/>QCon Beijing 2018</a></li></ul></ul><ul><li><a href=/blog/releases/>Releases</a></li><ul><li class=collapse id=blogreleases><a id=m-blog20200518past-releases href=/blog/2020/05/18/past-releases/>Past Releases</a></li></ul></ul></li></ul></ul></div><script>$(function(){$("#sidebarConsoleBtn").click(function(){$("#sidebarContent").toggle();});});</script></div><div class="col-md-2 blogDocToc"><div class=td-page-meta><a href="https://github.com/nacos-group/nacos-group.github.io/issues/new?title=Your%20First%20Dubbo%20Filter" target=_blank><i class="fa fa-github fa-fw"></i>Create documentation issue</a>
<a href=https://github.com/alibaba/nacos/issues/new target=_blank><i class="fa fa-tasks fa-fw"></i>Create project issue</a></div></div><div class=row><div class=col-md-2></div><div class="col-md-8 blogDocContent"><main role=main><a class="btn btn-lg rssIcon" href=/blog/news/index.xml target=_blank>RSS <i class="fa fa-rss ml-2"></i></a><div class=row><div class=col-md-2><ul></ul></div><div class=col-md-10></div></div><div class=td-content><h1>Your First Dubbo Filter</h1><div class=lead>This article will introduce you that how to implement a dubbo filter</div><div class="td-byline mb-4"><time datetime=2018-07-01 class=text-muted>Sunday, July 01, 2018</time></div><h3 id=overview>Overview</h3><p>In overall design of Dubbo, Filter is a very important concept, most of Dubbo&rsquo;s functions are based on this
extension point, and the Filter interception will be executed during each call.</p><h4 id=extension-mechanism-of-dubbo-filter>Extension Mechanism of Dubbo Filter</h4><p>There are already about 20 Filters implemented in Dubbo. Their entry is ProtocolFilterWrapper, ProtocolFilterWrapper
makes a Wrapper on Protocol and will be loaded when the extension is loaded. Then, let&rsquo;s see how
the Filter chain is constructed.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#586e75>//ProtocolFilterWrapper.java
</span><span style=color:#586e75></span><span style=color:#268bd2>public</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>refer</span><span style=color:#719e07>(</span>Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> type<span style=color:#719e07>,</span> URL url<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REGISTRY_PROTOCOL<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>url<span style=color:#719e07>.</span>getProtocol<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>return</span> protocol<span style=color:#719e07>.</span>refer<span style=color:#719e07>(</span>type<span style=color:#719e07>,</span> url<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> buildInvokerChain<span style=color:#719e07>(</span>protocol<span style=color:#719e07>.</span>refer<span style=color:#719e07>(</span>type<span style=color:#719e07>,</span> url<span style=color:#719e07>),</span> Constants<span style=color:#719e07>.</span>REFERENCE_FILTER_KEY<span style=color:#719e07>,</span> Constants<span style=color:#719e07>.</span>CONSUMER<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#268bd2>private</span> <span style=color:#268bd2>static</span> <span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>buildInvokerChain</span><span style=color:#719e07>(</span><span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> invoker<span style=color:#719e07>,</span> String key<span style=color:#719e07>,</span> String group<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> last <span style=color:#719e07>=</span> invoker<span style=color:#719e07>;</span>
        List<span style=color:#719e07>&lt;</span>Filter<span style=color:#719e07>&gt;</span> filters <span style=color:#719e07>=</span> ExtensionLoader<span style=color:#719e07>.</span>getExtensionLoader<span style=color:#719e07>(</span>Filter<span style=color:#719e07>.</span>class<span style=color:#719e07>).</span>getActivateExtension<span style=color:#719e07>(</span>invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>(),</span> key<span style=color:#719e07>,</span> group<span style=color:#719e07>);</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>filters<span style=color:#719e07>.</span>size<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> filters<span style=color:#719e07>.</span>size<span style=color:#719e07>()</span> <span style=color:#719e07>-</span> 1<span style=color:#719e07>;</span> i <span style=color:#719e07>&gt;=</span> 0<span style=color:#719e07>;</span> i <span style=color:#719e07>--)</span> <span style=color:#719e07>{</span>
                <span style=color:#268bd2>final</span> Filter filter <span style=color:#719e07>=</span> filters<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>i<span style=color:#719e07>);</span>
                <span style=color:#268bd2>final</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> next <span style=color:#719e07>=</span> last<span style=color:#719e07>;</span>
                last <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> Invoker<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;()</span> <span style=color:#719e07>{</span>

                    <span style=color:#268bd2>public</span> Class<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>getInterface</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                        <span style=color:#719e07>return</span> invoker<span style=color:#719e07>.</span>getInterface<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#268bd2>public</span> URL <span style=color:#268bd2>getUrl</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                        <span style=color:#719e07>return</span> invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#268bd2>public</span> <span style=color:#dc322f>boolean</span> <span style=color:#268bd2>isAvailable</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                        <span style=color:#719e07>return</span> invoker<span style=color:#719e07>.</span>isAvailable<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#268bd2>public</span> Result <span style=color:#268bd2>invoke</span><span style=color:#719e07>(</span>Invocation invocation<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
                        <span style=color:#719e07>return</span> filter<span style=color:#719e07>.</span>invoke<span style=color:#719e07>(</span>next<span style=color:#719e07>,</span> invocation<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#268bd2>public</span> <span style=color:#dc322f>void</span> <span style=color:#268bd2>destroy</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                        invoker<span style=color:#719e07>.</span>destroy<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>

                    <span style=color:#268bd2>@Override</span>
                    <span style=color:#268bd2>public</span> String <span style=color:#268bd2>toString</span><span style=color:#719e07>()</span> <span style=color:#719e07>{</span>
                        <span style=color:#719e07>return</span> invoker<span style=color:#719e07>.</span>toString<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>};</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> last<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>

</code></pre></div><h4 id=activation-mechanism-of-dubbo-filter>Activation Mechanism of Dubbo Filter</h4><p>Through the above code we can see that, in the method buildInvokerChain, first get all
activated chains, the chain here is already sorted. Then construct a call chain of Filter
through the Invoker, finally the constructed call chain can be roughly expressed as: Filter1->Filter2->Filter3->&mldr;&mldr;->Invoker,
now let&rsquo;s see the detailed flow of the activated chain in the above step.</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>    <span style=color:#268bd2>public</span> List<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>getActivateExtension</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> String key<span style=color:#719e07>,</span> String group<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        String value <span style=color:#719e07>=</span> url<span style=color:#719e07>.</span>getParameter<span style=color:#719e07>(</span>key<span style=color:#719e07>);</span>
        <span style=color:#719e07>return</span> getActivateExtension<span style=color:#719e07>(</span>url<span style=color:#719e07>,</span> value <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>||</span> value<span style=color:#719e07>.</span>length<span style=color:#719e07>()</span> <span style=color:#719e07>==</span> 0 <span style=color:#719e07>?</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>:</span> Constants<span style=color:#719e07>.</span>COMMA_SPLIT_PATTERN<span style=color:#719e07>.</span>split<span style=color:#719e07>(</span>value<span style=color:#719e07>),</span> group<span style=color:#719e07>);</span>
    <span style=color:#719e07>}</span>
    
    <span style=color:#268bd2>public</span> List<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> <span style=color:#268bd2>getActivateExtension</span><span style=color:#719e07>(</span>URL url<span style=color:#719e07>,</span> String<span style=color:#719e07>[]</span> values<span style=color:#719e07>,</span> String group<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
        List<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> exts <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;();</span>
        
        List<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;</span> names <span style=color:#719e07>=</span> values <span style=color:#719e07>==</span> <span style=color:#cb4b16>null</span> <span style=color:#719e07>?</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>&gt;(</span>0<span style=color:#719e07>)</span> <span style=color:#719e07>:</span> Arrays<span style=color:#719e07>.</span>asList<span style=color:#719e07>(</span>values<span style=color:#719e07>);</span>

        <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span> names<span style=color:#719e07>.</span>contains<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REMOVE_VALUE_PREFIX <span style=color:#719e07>+</span> Constants<span style=color:#719e07>.</span>DEFAULT_KEY<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
            getExtensionClasses<span style=color:#719e07>();</span>
            <span style=color:#719e07>for</span> <span style=color:#719e07>(</span>Map<span style=color:#719e07>.</span>Entry<span style=color:#719e07>&lt;</span>String<span style=color:#719e07>,</span> Activate<span style=color:#719e07>&gt;</span> entry <span style=color:#719e07>:</span> cachedActivates<span style=color:#719e07>.</span>entrySet<span style=color:#719e07>())</span> <span style=color:#719e07>{</span>
                String name <span style=color:#719e07>=</span> entry<span style=color:#719e07>.</span>getKey<span style=color:#719e07>();</span>
                Activate activate <span style=color:#719e07>=</span> entry<span style=color:#719e07>.</span>getValue<span style=color:#719e07>();</span>
                <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>isMatchGroup<span style=color:#719e07>(</span>group<span style=color:#719e07>,</span> activate<span style=color:#719e07>.</span>group<span style=color:#719e07>()))</span> <span style=color:#719e07>{</span>
                    T ext <span style=color:#719e07>=</span> getExtension<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span> names<span style=color:#719e07>.</span>contains<span style=color:#719e07>(</span>name<span style=color:#719e07>)</span> <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span> names<span style=color:#719e07>.</span>contains<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REMOVE_VALUE_PREFIX <span style=color:#719e07>+</span> name<span style=color:#719e07>)</span> 
                            <span style=color:#719e07>&amp;&amp;</span> isActive<span style=color:#719e07>(</span>activate<span style=color:#719e07>,</span> url<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                        exts<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>ext<span style=color:#719e07>);</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
            Collections<span style=color:#719e07>.</span>sort<span style=color:#719e07>(</span>exts<span style=color:#719e07>,</span> ActivateComparator<span style=color:#719e07>.</span>COMPARATOR<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        List<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;</span> usrs <span style=color:#719e07>=</span> <span style=color:#719e07>new</span> ArrayList<span style=color:#719e07>&lt;</span>T<span style=color:#719e07>&gt;();</span>
        <span style=color:#719e07>for</span> <span style=color:#719e07>(</span><span style=color:#dc322f>int</span> i <span style=color:#719e07>=</span> 0<span style=color:#719e07>;</span> i <span style=color:#719e07>&lt;</span> names<span style=color:#719e07>.</span>size<span style=color:#719e07>();</span> i <span style=color:#719e07>++)</span> <span style=color:#719e07>{</span>
            String name <span style=color:#719e07>=</span> names<span style=color:#719e07>.</span>get<span style=color:#719e07>(</span>i<span style=color:#719e07>);</span>
            <span style=color:#719e07>if</span> <span style=color:#719e07>(!</span> name<span style=color:#719e07>.</span>startsWith<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REMOVE_VALUE_PREFIX<span style=color:#719e07>)</span>
                    <span style=color:#719e07>&amp;&amp;</span> <span style=color:#719e07>!</span> names<span style=color:#719e07>.</span>contains<span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>REMOVE_VALUE_PREFIX <span style=color:#719e07>+</span> name<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                           <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>Constants<span style=color:#719e07>.</span>DEFAULT_KEY<span style=color:#719e07>.</span>equals<span style=color:#719e07>(</span>name<span style=color:#719e07>))</span> <span style=color:#719e07>{</span>
                    <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>usrs<span style=color:#719e07>.</span>size<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
                        exts<span style=color:#719e07>.</span>addAll<span style=color:#719e07>(</span>0<span style=color:#719e07>,</span> usrs<span style=color:#719e07>);</span>
                        usrs<span style=color:#719e07>.</span>clear<span style=color:#719e07>();</span>
                    <span style=color:#719e07>}</span>
                <span style=color:#719e07>}</span> <span style=color:#719e07>else</span> <span style=color:#719e07>{</span>
                    T ext <span style=color:#719e07>=</span> getExtension<span style=color:#719e07>(</span>name<span style=color:#719e07>);</span>
                    usrs<span style=color:#719e07>.</span>add<span style=color:#719e07>(</span>ext<span style=color:#719e07>);</span>
                <span style=color:#719e07>}</span>
            <span style=color:#719e07>}</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>usrs<span style=color:#719e07>.</span>size<span style=color:#719e07>()</span> <span style=color:#719e07>&gt;</span> 0<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            exts<span style=color:#719e07>.</span>addAll<span style=color:#719e07>(</span>usrs<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>return</span> exts<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
</code></pre></div><p>Through the above code we can see that, some of the Filters configured by the user are activated by default,
and some need to be activated by the configuration file. The loading order of all Filters is to process Dubbo&rsquo;s
default Filter first, and then to process the Filter defined by the user. With the &ldquo;-&rdquo; configuration, Dubbo&rsquo;s defualt Filter
can be replaced, with this configuration, the user can flexibly replace or modify the Filter&rsquo;s load order.</p><h4 id=built-in-filter-of-dubbo>Built-in Filter of Dubbo</h4><p>Dubbo has lots of built-in Filter. RpcContext, accesslog and other functions can be implemented by Dubbo.
Now let&rsquo;s see the ConsumerContextFilter which used by the Consumer side for context delivery:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> Result <span style=color:#268bd2>invoke</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker<span style=color:#719e07>,</span> Invocation invocation<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
        RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>()</span>
                <span style=color:#719e07>.</span>setInvoker<span style=color:#719e07>(</span>invoker<span style=color:#719e07>)</span>
                <span style=color:#719e07>.</span>setInvocation<span style=color:#719e07>(</span>invocation<span style=color:#719e07>)</span>
                <span style=color:#719e07>.</span>setLocalAddress<span style=color:#719e07>(</span>NetUtils<span style=color:#719e07>.</span>getLocalHost<span style=color:#719e07>(),</span> 0<span style=color:#719e07>)</span>
                <span style=color:#719e07>.</span>setRemoteAddress<span style=color:#719e07>(</span>invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>().</span>getHost<span style=color:#719e07>(),</span> 
                                  invoker<span style=color:#719e07>.</span>getUrl<span style=color:#719e07>().</span>getPort<span style=color:#719e07>());</span>
        <span style=color:#719e07>if</span> <span style=color:#719e07>(</span>invocation <span style=color:#719e07>instanceof</span> RpcInvocation<span style=color:#719e07>)</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>((</span>RpcInvocation<span style=color:#719e07>)</span>invocation<span style=color:#719e07>).</span>setInvoker<span style=color:#719e07>(</span>invoker<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span>
        <span style=color:#719e07>try</span> <span style=color:#719e07>{</span>
            <span style=color:#719e07>return</span> invoker<span style=color:#719e07>.</span>invoke<span style=color:#719e07>(</span>invocation<span style=color:#719e07>);</span>
        <span style=color:#719e07>}</span> <span style=color:#719e07>finally</span> <span style=color:#719e07>{</span>
            RpcContext<span style=color:#719e07>.</span>getContext<span style=color:#719e07>().</span>clearAttachments<span style=color:#719e07>();</span>
        <span style=color:#719e07>}</span>
    <span style=color:#719e07>}</span>
</code></pre></div><p>This Filter records the state information during call, and passes the attachments parameter set
by the client to the server through the invocation object, and these parameters will be cleared
after the call is completed, which is why the request status information can be recorded by times
and delivered.</p><h4 id=implement-a-dubbo-filter>Implement A Dubbo Filter</h4><p>Because of Dubbo&rsquo;s flexible design and good scalability, we can implement business logic
in the call chain by implementing our own Dubbo Filter, such as time-consuming statistics, monitor information statistics, etc.
Now, let&rsquo;s implement a simple Filter:</p><p>Maven project structure:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>src
 |-main
    |-java
        |-com
            |-xxx
                |-XxxFilter.java (impelement Filter interface)
    |-resources
        |-META-INF
            |-dubbo
                |-com.alibaba.dubbo.rpc.Filter (Plain text file with content：xxx=com.xxx.XxxFilter)
</code></pre></div><p>XxxFilter.java：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>XxxFilter</span> <span style=color:#268bd2>implements</span> Filter <span style=color:#719e07>{</span>
    <span style=color:#268bd2>public</span> Result <span style=color:#268bd2>invoke</span><span style=color:#719e07>(</span>Invoker<span style=color:#719e07>&lt;?&gt;</span> invoker<span style=color:#719e07>,</span> Invocation invocation<span style=color:#719e07>)</span> <span style=color:#268bd2>throws</span> RpcException <span style=color:#719e07>{</span>
        <span style=color:#586e75>// before filter ...
</span><span style=color:#586e75></span>        Result result <span style=color:#719e07>=</span> invoker<span style=color:#719e07>.</span>invoke<span style=color:#719e07>(</span>invocation<span style=color:#719e07>);</span>
        <span style=color:#586e75>// after filter ...
</span><span style=color:#586e75></span>        <span style=color:#719e07>return</span> result<span style=color:#719e07>;</span>
    <span style=color:#719e07>}</span>
<span style=color:#719e07>}</span>
</code></pre></div><p>META-INF/dubbo/com.alibaba.dubbo.rpc.Filter：</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback>xxx=com.xxx.XxxFilter
</code></pre></div><p>configure in xml as:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#586e75>&lt;!-- Consumer call process interception --&gt;</span>
<span style=color:#268bd2>&lt;dubbo:reference</span> filter=<span style=color:#2aa198>&#34;xxx&#34;</span> <span style=color:#268bd2>/&gt;</span>
<span style=color:#586e75>&lt;!-- Consumer call process default interception，intercept all reference --&gt;</span>
<span style=color:#268bd2>&lt;dubbo:consumer</span> filter=<span style=color:#2aa198>&#34;xxx&#34;</span><span style=color:#268bd2>/&gt;</span>
<span style=color:#586e75>&lt;!-- Provider call process interception --&gt;</span>
<span style=color:#268bd2>&lt;dubbo:service</span> filter=<span style=color:#2aa198>&#34;xxx&#34;</span> <span style=color:#268bd2>/&gt;</span>
<span style=color:#586e75>&lt;!-- Provider call process default interception，intercept all service --&gt;</span>
<span style=color:#268bd2>&lt;dubbo:provider</span> filter=<span style=color:#2aa198>&#34;xxx&#34;</span><span style=color:#268bd2>/&gt;</span>
</code></pre></div><p>or use annotation as:</p><div class=highlight><pre style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#268bd2>@Activate</span><span style=color:#719e07>(</span>group <span style=color:#719e07>=</span> <span style=color:#2aa198>&#34;consumer&#34;</span><span style=color:#719e07>)</span>
<span style=color:#268bd2>public</span> <span style=color:#268bd2>class</span> <span style=color:#268bd2>XxxFilter</span> <span style=color:#268bd2>implements</span> Filter <span style=color:#719e07>{</span>
    <span style=color:#586e75>// ...
</span><span style=color:#586e75></span><span style=color:#719e07>}</span>
</code></pre></div><p>Using xml configuration is more flexible and granular.</p><p>In before and after, you can implement your own business logic to give the filter a certain function.
Once written and configured, the filter is activated by the Dubbo and executed in the call chain.</p></div></main></div><div class=col-md-2></div></div></section><footer id=footer role=contentinfo><div class=container><img src=/images/nacos_gray.png><div class=row><div class=col-md-6><h3>Vision</h3><p>By providing an easy-to-use service infrastructure such as dynamic service
discovery, service configuration, service sharing and management and etc., Nacos help users better
construct, deliver and manage their own service platform, reuse and composite business service
faster and deliver value of business innovation more quickly so as to win market for users in the
era of cloud native and in all cloud environments, such as private, mixed, or public clouds.</p></div><div class=col-md-3><dl><dt>Documentation</dt><dd><a href=/en-us/docs/what-is-nacos.html target=_self>Overview</a></dd><dd><a href=/en-us/docs/quick-start.html target=_self>Quick start</a></dd><dd><a href=/en-us/docs/contributing.html target=_self>Developer guide</a></dd></dl></div><div class=col-md-3><dl><dt>Resources</dt><dd><a href=/en-us/community/index.html target=_self>Community</a></dd><dd><a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target=_self>Cloud Service MSE</a></dd><dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target=_self>Cloud Service EDAS</a></dd><dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target=_self>Cloud Service AHAS</a></dd></dl></div></div><div class="col-md-12 text-center copyright"><span>© 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span></div></div></footer></body><script type=text/javascript>;(function(){$('#fh5co-header').addClass('navbar-fixed-top fh5co-animated slideInDown');$('#nacosLogo').attr("src","/images/nacos_colorful.png")}());</script></html>