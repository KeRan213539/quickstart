<!DOCTYPE html>






<html lang="en">
<head>
  

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> Dubbo: Several ways about synchronous/asynchronous invoke</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    
    <meta http-equiv="content-language" content="en-us" />

  

    
    
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Nacos">
    <meta property="og:title" content="Dubbo: Several ways about synchronous/asynchronous invoke">
    <meta property="og:url" content="/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/">
    <meta property="og:image" content="/images/">
    <meta name="twitter:title" content="Nacos" />
    <meta name="twitter:url" content="/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/" />
    <meta name="twitter:image" content="/images/" />
    <meta name="twitter:card" content="" />
    
    
    
    <link rel="canonical" href="/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/"/>

    


    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600,400italic,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/css/leaflet.css" />

    
    <link rel="stylesheet" href="/css/animate.css">
    
    <link rel="stylesheet" href="/css/icomoon.css">
    
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    
    <link rel="stylesheet" href="/css/magnific-popup.css">
    
    <link rel="stylesheet" href="/css/bootstrap.css">

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <link rel="stylesheet" href="/css/custom1.css">
    
    <link rel="stylesheet" href="/css/custom2.css">
    
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    

    
    <script src="/js/modernizr-2.6.2.min.js"></script>
    
    

  <meta name="referrer" content="no-referrer"/>
  <link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
  	
	<script src="/js/jquery.min.js"></script>
	
	<script src="/js/jquery.easing.1.3.js"></script>
	
	<script src="/js/bootstrap.min.js"></script>
	
	<script src="/js/jquery.waypoints.min.js"></script>
	
	<script src="/js/jquery.stellar.min.js"></script>
	
	<script src="/js/jquery.countTo.js"></script>
	
	<script src="/js/jquery.magnific-popup.min.js"></script>
	<script src="/js/magnific-popup-options.js"></script>
	


	
	<script src="/js/main.js"></script>

</head>
<body>


    <header role="banner" id="fh5co-header">
        <div class="container">
            
            <nav class="navbar navbar-default">
                <div class="navbar-header">
                    
                    <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><i></i></a>
                    <a class="navbar-brand" href="index.html"><img id="nacosLogo" src="/images/nacos.png"></a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav navbar-right">
                    
                    
                    
                    <li><a class="external" href="/"><span>Home</span></a></li>
                    
                    
                    

                    

                    

                    

                    

                    
                        <li><a class="external" href="/docs"><span>Documentation</span></a></li>
                    
                        <li class="active"><a class="external" href="/blog"><span>Blog</span></a></li>
                    
                    <li>
                      

<div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false" >
		English
		<span class="caret"></span>
	</button>
	<ul class="dropdown-menu">
		
		<li><a class="external" href="/zh/blog/2018/08/14/dubbo-%E5%85%B3%E4%BA%8E%E5%90%8C%E6%AD%A5/%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/">中文</a></li>
		
	</ul>
</div>
                    </li>
                </ul>
            </div>
        </nav>
        
    </div>
</header>

<section class="animated">
  <div class="col-md-2 blogDocSidebar">
    




<a href="#" id="sidebarConsoleBtn"><i class="fa fa-bars fa-fw"></i></a>
<div id="sidebarContent">
  
  






<ul>
  <li>
    <a href="/blog/" >Blog</a>
  </li>
  <ul>
    <li class="collapse show" id="blog">
      
      
      
      
        
          






<ul>
  <li>
    <a class="active" href="/blog/news/" >Articles</a>
  </li>
  <ul>
    <li class="collapse show" id="blognews">
      
      
      
      
        
          
          
          <a id="m-blog20190826service-test" href="/blog/2019/08/26/service-test/">Service test in dubbo admin</a>
        
      
      
      
        
          
          
          <a id="m-blog20190811tracing-dubbo-service-with-apache-skywalking" href="/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/">Use apache skywalking in dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2" href="/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/">Dubbo extensible mechanism - part 2</a>
        
      
      
      
        
          
          
          <a id="m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1" href="/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/">Dubbo extensible mechanism - part 1</a>
        
      
      
      
        
          
          
          <a id="m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface" href="/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/">Dubbo Async Client</a>
        
      
      
      
        
          
          
          <a id="m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface" href="/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/">Dubbo Async Server</a>
        
      
      
      
        
          
          
          <a id="m-blog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices" href="/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/">Use Seata in Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou" href="/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/">The fifth Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry" href="/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/">Use Dubbo with Nacos</a>
        
      
      
      
        
          
          
          <a id="m-blog20181005introduction-to-the-dubbo-protocol" href="/blog/2018/10/05/introduction-to-the-dubbo-protocol/">Introduction to the Dubbo protocol</a>
        
      
      
      
        
          
          
          <a id="m-blog20180930integrate-dubbo-with-kubernetes" href="/blog/2018/09/30/integrate-dubbo-with-kubernetes/">Integrate Dubbo with Kubernetes</a>
        
      
      
      
        
          
          
          <a id="m-blog20180902how-to-prepare-an-apache-release" href="/blog/2018/09/02/how-to-prepare-an-apache-release/">How to prepare an Apache Release</a>
        
      
      
      
        
          
          
          <a id="m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo" href="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/">New Async Call</a>
        
      
      
      
        
          
          
          <a id="m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu" href="/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/">The fourth Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration" href="/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/">Dubbo Consumer Configuration</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke" class="active2" href="/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/">Dubbo Invoke</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-basic-usage-dubbo-provider-configuration" href="/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/">Dubbo Provider Configuration</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814manipulating-services-dynamically-via-qos" href="/blog/2018/08/14/manipulating-services-dynamically-via-qos/">Dubbo QoS Introduction</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop" href="/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/">Dubbo start/stop in spring boot</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814implementation-of-cross-language-calls-by-dubbo2js" href="/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/">dubbo2.js introduction</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814generic-invoke-of-dubbo" href="/blog/2018/08/14/generic-invoke-of-dubbo/">Generic invoke</a>
        
      
      
      
        
          
          
          <a id="m-blog20180810dubbos-load-balance" href="/blog/2018/08/10/dubbos-load-balance/">Dubbo&#39;s Load Balance</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807use-annotations-in-dubbo" href="/blog/2018/08/07/use-annotations-in-dubbo/">Use Annotations In Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807using-zookeeper-in-dubbo" href="/blog/2018/08/07/using-zookeeper-in-dubbo/">Using Zookeeper in Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807dubbo-101" href="/blog/2018/08/07/dubbo-101/">Your First Dubbo Demo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen" href="/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/">The third Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services" href="/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/">Introduce sentinel</a>
        
      
      
      
        
          
          
          <a id="m-blog20180712tracking-with-pinpoint" href="/blog/2018/07/12/tracking-with-pinpoint/">Tracking with Pinpoint</a>
        
      
      
      
        
          
          
          <a id="m-blog20180701your-first-dubbo-filter" href="/blog/2018/07/01/your-first-dubbo-filter/">Your First Dubbo Filter</a>
        
      
      
      
        
          
          
          <a id="m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully" href="/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/">The second Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing" href="/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/">The first Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180502the-apachecon-na-schedule-has-been-announced" href="/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/">ApacheCon NA</a>
        
      
      
      
        
          
          
          <a id="m-blog20180425the-gsocgoogle-summer-of-code-2018" href="/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/">GSoC 2018</a>
        
      
      
      
        
          
          
          <a id="m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018" href="/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/">QCon Beijing 2018</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/blog/releases/" >Releases</a>
  </li>
  <ul>
    <li class="collapse " id="blogreleases">
      
      
      
      
        
          
          
          <a id="m-blog20200518past-releases" href="/blog/2020/05/18/past-releases/">Past Releases</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

</div>

<script>
  $(function() {
    $("#sidebarConsoleBtn").click(function () {
      $("#sidebarContent").toggle();
    });
  });
</script>



  </div>
  <div class="col-md-2 blogDocToc">
    






<div class="td-page-meta">






<a href="https://github.com/nacos-group/nacos-group.github.io/issues/new?title=Dubbo:%20Several%20ways%20about%20synchronous/asynchronous%20invoke" target="_blank"><i class="fa fa-github fa-fw"></i> Create documentation issue</a>


<a href="https://github.com/alibaba/nacos/issues/new" target="_blank"><i class="fa fa-tasks fa-fw"></i> Create project issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#synchronous-invoke">Synchronous invoke</a></li>
        <li><a href="#asynchronous-invoke">Asynchronous invoke</a></li>
        <li><a href="#parameters-callback">Parameters callback</a></li>
        <li><a href="#event-notification">Event notification</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </div>
  <div class="row">
    <div class="col-md-2">
    </div>
    <div class="col-md-8 blogDocContent">
      <main role="main">
        <a class="btn btn-lg rssIcon" href="/blog/news/index.xml"
           target="_blank">
          RSS <i class="fa fa-rss ml-2 "></i>
        </a>
        


<div class="row">
  <div class="col-md-2">
    <ul>
      
    </ul>
  </div>
  <div class="col-md-10">
    
  </div>
</div>
<div class="td-content">
  <h1>Dubbo: Several ways about synchronous/asynchronous invoke</h1>
  
  <div class="lead">This article introduces you how to use Dubbo synchronously or asynchronously.</div>
  
  <div class="td-byline mb-4">
    <time datetime="2018-08-14" class="text-muted">Tuesday, August 14, 2018</time>
  </div>
  
  <p>As we all know，Dubbo adopts a single large join protocol by default and takes the NIO asynchronous communication mechanism of Netty as the low-level implementation. Based on this mechanism, Dubbo implements several invocation modes as follows:</p>
<ul>
<li>synchronous invoke</li>
<li>asynchronous invoke</li>
<li>parameters callback</li>
<li>event notification</li>
</ul>
<h3 id="synchronous-invoke">Synchronous invoke</h3>
<p>Synchronous invoke is a kind of blocking invocation mode, that is the Consumer keeps blocking and waiting, until the Provider returns.</p>
<p>Generally, a typical synchronous invocation process is as follows:</p>
<ol>
<li>Consumer service thread invokes the remote API and sends requests to the Provider. Meanwhile, the current service thread stays in blocking state;</li>
<li>Provider process relative request after receiving it from Consumer. Then returns the results to Consumer;</li>
<li>After Consumer receiving results, the current thread continues to execute.</li>
</ol>
<p>Here are two problems:</p>
<ol>
<li>How does Consumer service thread turn into <code>blocking</code> state?</li>
<li>How does the service thread be awaked to execute after Consumer receiving results?</li>
</ol>
<p>In fact, the low-level I/O operations of Dubbo are all asynchronous. The Consumer gets a Future object after invoking the Provider. For synchronous invoke, the service thread takes advantage of <code>Future#get(timeout)</code> to block and wait for Provider returning results, with the &lsquo;timeout&rsquo; indicating the timeout defined by Consumer. When the result returns, the Future will be set and the blocked service thread will be awaked. The service thread will return an exception if there is no result after timeout.</p>
<h3 id="asynchronous-invoke">Asynchronous invoke</h3>
<p>For scenarios that Provider has a long response time, it&rsquo;s necessary to implement asynchronous invoke based on Dubbo&rsquo;s underlying asynchronous NIO. It could utilize the resource of Consumer effectively, and costs less than using multi-thread for Consumer.</p>
<p>Asynchronous invoke does not need specific configuration for Provider. In the example，the API of Provider is defined as follow：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    String <span style="color:#268bd2">goodbye</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><h5 id="consumer-configuration">Consumer configuration</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;asyncService&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span><span style="color:#268bd2">&gt;</span>
    <span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;goodbye&#34;</span> async=<span style="color:#2aa198">&#34;true&#34;</span><span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;/dubbo:reference&gt;</span>
</code></pre></div><p>Notice that if we need an asynchronous revoke method, we must use <code>&lt;dubbo:method/&gt;</code> label to describe it.</p>
<h5 id="consumer-triggers-invocation">Consumer triggers invocation</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">AsyncService service <span style="color:#719e07">=</span> <span style="color:#719e07">...;</span>
String result <span style="color:#719e07">=</span> service<span style="color:#719e07">.</span>goodbye<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;samples&#34;</span><span style="color:#719e07">);</span><span style="color:#586e75">// returns NULL and DO NOT use!
</span><span style="color:#586e75"></span>Future<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> future <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>getContext<span style="color:#719e07">().</span>getFuture<span style="color:#719e07">();</span>
<span style="color:#719e07">...</span> <span style="color:#586e75">// other service thread logic
</span><span style="color:#586e75"></span>result <span style="color:#719e07">=</span> future<span style="color:#719e07">.</span>get<span style="color:#719e07">();</span> <span style="color:#586e75">// could use get(timeout, unit) to configure timeout, when it needs to get the asynchronous result
</span></code></pre></div><p>After Dubbo Consumer triggers invocation, it uses <code>RpcContext.getContext().getFuture()</code> to get the relative <code>Future</code> object, and then it could start executing other tasks. Anytime when we need results, <code>future.get(timeout)</code> is supposed to be called.</p>
<p>Under several special conditions, it could be set whether to wait for sending the request, to accelerate the return of invocation:</p>
<ul>
<li><code>sent=&quot;true&quot;</code> Waiting for sending the request, and return an exception if it fails;</li>
<li><code>sent=&quot;false&quot;</code> Do not wait for the request, and returns immediately after putting the request to the I/O queue.</li>
</ul>
<p>We set it to <code>false</code> by default. And detailed configuration is as follows：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;goodbye&#34;</span> async=<span style="color:#2aa198">&#34;true&#34;</span> sent=<span style="color:#2aa198">&#34;true&#34;</span> <span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>If you only want to be asynchronous, then omit the result thoroughly, <code>return=&quot;false&quot;</code> could be set to reduce the creation and management cost of Future:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;goodbye&#34;</span> async=<span style="color:#2aa198">&#34;true&#34;</span> return=<span style="color:#2aa198">&#34;false&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>At this time，<code>RpcContext.getContext().getFuture()</code> will return <code>null</code>。</p>
<p>The complete sequence diagram of asynchronous invoke is as follow:</p>
<p><img src="/imgs/blog/dubbo-async.svg" alt="Asynchronous invoke"></p>
<p>The sample locates at：https://github.com/dubbo/dubbo-samples/tree/master/dubbo-samples-async</p>
<h3 id="parameters-callback">Parameters callback</h3>
<p>The parameter Callback is somewhat similar to the local Callback mechanism, but Callback is not an inner class or interface of Dubbo. Instead, it is defined by the Provider. Dubbo will generate a reverse proxy based on the long connection, so as to implement the logic of calling the Consumer from the Provider.</p>
<h5 id="service-and-callback-definition-of-provider">Service and Callback definition of Provider</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">CallbackService</span> <span style="color:#719e07">{</span>
    <span style="color:#dc322f">void</span> <span style="color:#268bd2">addListener</span><span style="color:#719e07">(</span>String key<span style="color:#719e07">,</span> CallbackListener listener<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>

<span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">CallbackListener</span> <span style="color:#719e07">{</span>
    <span style="color:#dc322f">void</span> <span style="color:#268bd2">changed</span><span style="color:#719e07">(</span>String msg<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><h5 id="service-implementation-of-provider">Service implementation of Provider</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">CallbackServiceImpl</span> <span style="color:#268bd2">implements</span> CallbackService <span style="color:#719e07">{</span>

    <span style="color:#268bd2">private</span> <span style="color:#268bd2">final</span> Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> CallbackListener<span style="color:#719e07">&gt;</span> listeners <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ConcurrentHashMap<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> CallbackListener<span style="color:#719e07">&gt;();</span>

    <span style="color:#268bd2">public</span> <span style="color:#268bd2">CallbackServiceImpl</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
        Thread t <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> Thread<span style="color:#719e07">(</span><span style="color:#719e07">new</span> Runnable<span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
            <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">run</span><span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">while</span> <span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                    <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>Map<span style="color:#719e07">.</span>Entry<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> CallbackListener<span style="color:#719e07">&gt;</span> entry <span style="color:#719e07">:</span> listeners<span style="color:#719e07">.</span>entrySet<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
                            <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                                entry<span style="color:#719e07">.</span>getValue<span style="color:#719e07">().</span>changed<span style="color:#719e07">(</span>getChanged<span style="color:#719e07">(</span>entry<span style="color:#719e07">.</span>getKey<span style="color:#719e07">()));</span>
                            <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>Throwable t<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                                listeners<span style="color:#719e07">.</span>remove<span style="color:#719e07">(</span>entry<span style="color:#719e07">.</span>getKey<span style="color:#719e07">());</span>
                            <span style="color:#719e07">}</span>
                        <span style="color:#719e07">}</span>
                        Thread<span style="color:#719e07">.</span>sleep<span style="color:#719e07">(</span>5000<span style="color:#719e07">);</span> <span style="color:#586e75">// timely trigger change event
</span><span style="color:#586e75"></span>                    <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>Throwable t<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                        t<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
                    <span style="color:#719e07">}</span>
                <span style="color:#719e07">}</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">});</span>
        t<span style="color:#719e07">.</span>setDaemon<span style="color:#719e07">(</span><span style="color:#cb4b16">true</span><span style="color:#719e07">);</span>
        t<span style="color:#719e07">.</span>start<span style="color:#719e07">();</span>
    <span style="color:#719e07">}</span>

    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">addListener</span><span style="color:#719e07">(</span>String key<span style="color:#719e07">,</span> CallbackListener listener<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        listeners<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span>key<span style="color:#719e07">,</span> listener<span style="color:#719e07">);</span>
        listener<span style="color:#719e07">.</span>changed<span style="color:#719e07">(</span>getChanged<span style="color:#719e07">(</span>key<span style="color:#719e07">));</span> <span style="color:#586e75">// send notification for change
</span><span style="color:#586e75"></span>    <span style="color:#719e07">}</span>

    <span style="color:#268bd2">private</span> String <span style="color:#268bd2">getChanged</span><span style="color:#719e07">(</span>String key<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> <span style="color:#2aa198">&#34;Changed: &#34;</span> <span style="color:#719e07">+</span> <span style="color:#719e07">new</span> SimpleDateFormat<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span style="color:#719e07">).</span>format<span style="color:#719e07">(</span><span style="color:#719e07">new</span> Date<span style="color:#719e07">());</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><h5 id="service-exposure-of-provider">Service exposure of Provider</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;bean</span> id=<span style="color:#2aa198">&#34;callbackService&#34;</span> class=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.callback.impl.CallbackServiceImpl&#34;</span><span style="color:#268bd2">/&gt;</span>

<span style="color:#268bd2">&lt;dubbo:service</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.callback.api.CallbackService&#34;</span> ref=<span style="color:#2aa198">&#34;callbackService&#34;</span> connections=<span style="color:#2aa198">&#34;1&#34;</span> callbacks=<span style="color:#2aa198">&#34;1000&#34;</span><span style="color:#268bd2">&gt;</span>
    <span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;addListener&#34;</span><span style="color:#268bd2">&gt;</span>
        <span style="color:#268bd2">&lt;dubbo:argument</span> index=<span style="color:#2aa198">&#34;1&#34;</span> callback=<span style="color:#2aa198">&#34;true&#34;</span><span style="color:#268bd2">/&gt;</span>
        <span style="color:#586e75">&lt;!--&lt;dubbo:argument type=&#34;com.demo.CallbackListener&#34; callback=&#34;true&#34; /&gt;--&gt;</span>
    <span style="color:#268bd2">&lt;/dubbo:method&gt;</span>
<span style="color:#268bd2">&lt;/dubbo:service&gt;</span>
</code></pre></div><p>Here，Provider needs to declare which parameter is the Callback parameter in the method.</p>
<h5 id="callback-interface-implementation-of-consumer">Callback interface implementation of Consumer</h5>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CallbackService callbackService <span style="color:#719e07">=</span> <span style="color:#719e07">...;</span>
callbackService<span style="color:#719e07">.</span>addListener<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;foo.bar&#34;</span><span style="color:#719e07">,</span> <span style="color:#719e07">new</span> CallbackListener<span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
        <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">changed</span><span style="color:#719e07">(</span>String msg<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;callback1:&#34;</span> <span style="color:#719e07">+</span> msg<span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span>
<span style="color:#719e07">});</span>
</code></pre></div><p>The implementation class of the Callback interface is on the Consumer, which automatically exports a Callback service when the method is called. Thus during Provider processing the call, if the parameter is determined as Callback, it will generate a proxy. Therefore, when the service implementation class calling the Callback method, it will be passed to the Consumer to execute the code.</p>
<p>The sample code above is located at：https://github.com/dubbo/dubbo-samples/tree/master/dubbo-samples-callback</p>
<p>This invocation mode is somewhat like message publishing and subscribing, but there is a little difference. For example, when the Consumer completes the export of Callback service, if it restarts later, then the Provider will fail to adjust. Meanwhile it is also a problem for the Provider to clean up the proxy.</p>
<h3 id="event-notification">Event notification</h3>
<p>Event notification allows the Consumer triggering three events，particularly <code>oninvoke</code>, <code>onreturn</code>, <code>onthrow</code> before calling, after calling or occurring exceptions.</p>
<p>You can specify which events need to be notified during configuring Consumer, such as:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;bean</span> id=<span style="color:#2aa198">&#34;demoCallback&#34;</span> class=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.notify.impl.NotifyImpl&#34;</span> <span style="color:#268bd2">/&gt;</span>

<span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;demoService&#34;</span> check=<span style="color:#2aa198">&#34;false&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.notify.api.DemoService&#34;</span> version=<span style="color:#2aa198">&#34;1.0.0&#34;</span> group=<span style="color:#2aa198">&#34;cn&#34;</span><span style="color:#268bd2">&gt;</span>
    <span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;sayHello&#34;</span> onreturn=<span style="color:#2aa198">&#34;demoCallback.onreturn&#34;</span> onthrow=<span style="color:#2aa198">&#34;demoCallback.onthrow&#34;</span><span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;/dubbo:reference&gt;</span>
</code></pre></div><p>Among them，the code of NotifyImpl is as follow：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">NotifyImpl</span> <span style="color:#268bd2">implements</span> Notify<span style="color:#719e07">{</span>

    <span style="color:#268bd2">public</span> Map<span style="color:#719e07">&lt;</span>Integer<span style="color:#719e07">,</span> String<span style="color:#719e07">&gt;</span> ret <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashMap<span style="color:#719e07">&lt;</span>Integer<span style="color:#719e07">,</span> String<span style="color:#719e07">&gt;();</span>

    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">onreturn</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">,</span> <span style="color:#dc322f">int</span> id<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        ret<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span>id<span style="color:#719e07">,</span> name<span style="color:#719e07">);</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;onreturn: &#34;</span> <span style="color:#719e07">+</span> name<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>

    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">onthrow</span><span style="color:#719e07">(</span>Throwable ex<span style="color:#719e07">,</span> String name<span style="color:#719e07">,</span> <span style="color:#dc322f">int</span> id<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;onthrow: &#34;</span> <span style="color:#719e07">+</span> name<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>Here we address that the parameter rules of three methods in the custom Notify interface are as follows:</p>
<ul>
<li><code>oninvoke</code> method&rsquo;s parameters are the same as the calling method parameters;</li>
<li><code>onreturn</code> method&rsquo;s first parameter is the returned value of calling method，and the others are the same as the calling method;</li>
<li><code>onthrow</code> method&rsquo;s first parameter is an invoked exception，and the others are the same as the calling method.</li>
</ul>
<p>In the above configuration, <code>sayHello</code> method is an asynchronous invocation, so the execution of event notification method is also synchronous. You can configure the <code>async = true</code> to make method invocation asynchronous, at this moment, event notification method is executed asynchronously. Especially emphasize that <code>oninvoke</code> method is executed synchronously, whether is an asynchronous call or not.</p>
<p>Please refer to the sample code for event notification：https://github.com/dubbo/dubbo-samples/tree/master/dubbo-samples-notify</p>

  
  
</div>


      </main>
    </div>
    <div class="col-md-2">
    </div>
  </div>
  
</section>

  

<footer id="footer" role="contentinfo">
  <div class="container">
    <img src="/images/nacos_gray.png"/>
    <div class="row">
      <div class="col-md-6"><h3>Vision</h3>
        <p>By providing an easy-to-use service infrastructure such as dynamic service
            discovery, service configuration, service sharing and management and etc., Nacos help users better
            construct, deliver and manage their own service platform, reuse and composite business service
            faster and deliver value of business innovation more quickly so as to win market for users in the
            era of cloud native and in all cloud environments, such as private, mixed, or public clouds.</p></div>
      <div class="col-md-3">
        <dl>
          <dt>Documentation</dt>
          
          <dd><a href="/en-us/docs/what-is-nacos.html" target="_self">Overview</a></dd>
          
          <dd><a href="/en-us/docs/quick-start.html" target="_self">Quick start</a></dd>
          
          <dd><a href="/en-us/docs/contributing.html" target="_self">Developer guide</a></dd>
          
        </dl>
      </div>
      <div class="col-md-3">
        <dl>
          <dt>Resources</dt>
          
          <dd><a href="/en-us/community/index.html" target="_self">Community</a></dd>
          
          <dd><a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_self">Cloud Service MSE</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">Cloud Service EDAS</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">Cloud Service AHAS</a></dd>
          
        </dl>
      </div>
    </div>
    <div class="col-md-12 text-center copyright">
      <span>© 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span>
    </div>
  </div>
</footer>


</body>
<script type="text/javascript">
  ;(function () {
    $('#fh5co-header').addClass('navbar-fixed-top fh5co-animated slideInDown');
    $('#nacosLogo').attr("src", "/images/nacos_colorful.png")
  }());
</script>
</html>