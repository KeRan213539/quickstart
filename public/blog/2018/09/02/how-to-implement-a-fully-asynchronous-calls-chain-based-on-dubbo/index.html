<!DOCTYPE html>






<html lang="en">
<head>
  

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> How to implement a fully asynchronous calls chain based on Dubbo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    
    <meta http-equiv="content-language" content="en-us" />

  

    
    
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Nacos">
    <meta property="og:title" content="How to implement a fully asynchronous calls chain based on Dubbo">
    <meta property="og:url" content="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/">
    <meta property="og:image" content="/images/">
    <meta name="twitter:title" content="Nacos" />
    <meta name="twitter:url" content="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/" />
    <meta name="twitter:image" content="/images/" />
    <meta name="twitter:card" content="" />
    
    
    
    <link rel="canonical" href="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/"/>

    


    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600,400italic,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/css/leaflet.css" />

    
    <link rel="stylesheet" href="/css/animate.css">
    
    <link rel="stylesheet" href="/css/icomoon.css">
    
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    
    <link rel="stylesheet" href="/css/magnific-popup.css">
    
    <link rel="stylesheet" href="/css/bootstrap.css">

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <link rel="stylesheet" href="/css/custom1.css">
    
    <link rel="stylesheet" href="/css/custom2.css">
    
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    

    
    <script src="/js/modernizr-2.6.2.min.js"></script>
    
    

  <meta name="referrer" content="no-referrer"/>
  <link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
  	
	<script src="/js/jquery.min.js"></script>
	
	<script src="/js/jquery.easing.1.3.js"></script>
	
	<script src="/js/bootstrap.min.js"></script>
	
	<script src="/js/jquery.waypoints.min.js"></script>
	
	<script src="/js/jquery.stellar.min.js"></script>
	
	<script src="/js/jquery.countTo.js"></script>
	
	<script src="/js/jquery.magnific-popup.min.js"></script>
	<script src="/js/magnific-popup-options.js"></script>
	


	
	<script src="/js/main.js"></script>

</head>
<body>


    <header role="banner" id="fh5co-header">
        <div class="container">
            
            <nav class="navbar navbar-default">
                <div class="navbar-header">
                    
                    <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><i></i></a>
                    <a class="navbar-brand" href="index.html"><img id="nacosLogo" src="/images/nacos.png"></a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav navbar-right">
                    
                    
                    
                    <li><a class="external" href="/"><span>Home</span></a></li>
                    
                    
                    

                    

                    

                    

                    

                    
                        <li><a class="external" href="/docs"><span>Documentation</span></a></li>
                    
                        <li class="active"><a class="external" href="/blog"><span>Blog</span></a></li>
                    
                    <li>
                      

<div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false" >
		English
		<span class="caret"></span>
	</button>
	<ul class="dropdown-menu">
		
		<li><a class="external" href="/zh/blog/2018/09/02/%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8Edubbo%E5%AE%9E%E7%8E%B0%E5%85%A8%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8%E9%93%BE/">中文</a></li>
		
	</ul>
</div>
                    </li>
                </ul>
            </div>
        </nav>
        
    </div>
</header>

<section class="animated">
  <div class="col-md-2 blogDocSidebar">
    




<a href="#" id="sidebarConsoleBtn"><i class="fa fa-bars fa-fw"></i></a>
<div id="sidebarContent">
  
  






<ul>
  <li>
    <a href="/blog/" >Blog</a>
  </li>
  <ul>
    <li class="collapse show" id="blog">
      
      
      
      
        
          






<ul>
  <li>
    <a class="active" href="/blog/news/" >Articles</a>
  </li>
  <ul>
    <li class="collapse show" id="blognews">
      
      
      
      
        
          
          
          <a id="m-blog20190826service-test" href="/blog/2019/08/26/service-test/">Service test in dubbo admin</a>
        
      
      
      
        
          
          
          <a id="m-blog20190811tracing-dubbo-service-with-apache-skywalking" href="/blog/2019/08/11/tracing-dubbo-service-with-apache-skywalking/">Use apache skywalking in dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20190502dubbo-extensible-mechanism-source-code-analysis-part-2" href="/blog/2019/05/02/dubbo-extensible-mechanism-source-code-analysis-part-2/">Dubbo extensible mechanism - part 2</a>
        
      
      
      
        
          
          
          <a id="m-blog20190425dubbo-extensible-mechanism-source-code-analysis-part-1" href="/blog/2019/04/25/dubbo-extensible-mechanism-source-code-analysis-part-1/">Dubbo extensible mechanism - part 1</a>
        
      
      
      
        
          
          
          <a id="m-blog20190220implementation-background-and-practice-of-dubbo-client-asynchronous-interface" href="/blog/2019/02/20/implementation-background-and-practice-of-dubbo-client-asynchronous-interface/">Dubbo Async Client</a>
        
      
      
      
        
          
          
          <a id="m-blog20190220implementation-background-and-practice-of-dubbo-server-asynchronous-interface" href="/blog/2019/02/20/implementation-background-and-practice-of-dubbo-server-asynchronous-interface/">Dubbo Async Server</a>
        
      
      
      
        
          
          
          <a id="m-blog20190117how-to-use-seata-to-ensure-consistency-between-dubbo-microservices" href="/blog/2019/01/17/how-to-use-seata-to-ensure-consistency-between-dubbo-microservices/">Use Seata in Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20181210the-fifth-dubbo-meetup-has-been-held-in-hangzhou" href="/blog/2018/12/10/the-fifth-dubbo-meetup-has-been-held-in-hangzhou/">The fifth Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20181107dubbo-integrates-with-nacos-to-become-a-registry" href="/blog/2018/11/07/dubbo-integrates-with-nacos-to-become-a-registry/">Use Dubbo with Nacos</a>
        
      
      
      
        
          
          
          <a id="m-blog20181005introduction-to-the-dubbo-protocol" href="/blog/2018/10/05/introduction-to-the-dubbo-protocol/">Introduction to the Dubbo protocol</a>
        
      
      
      
        
          
          
          <a id="m-blog20180930integrate-dubbo-with-kubernetes" href="/blog/2018/09/30/integrate-dubbo-with-kubernetes/">Integrate Dubbo with Kubernetes</a>
        
      
      
      
        
          
          
          <a id="m-blog20180902how-to-prepare-an-apache-release" href="/blog/2018/09/02/how-to-prepare-an-apache-release/">How to prepare an Apache Release</a>
        
      
      
      
        
          
          
          <a id="m-blog20180902how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo" class="active2" href="/blog/2018/09/02/how-to-implement-a-fully-asynchronous-calls-chain-based-on-dubbo/">New Async Call</a>
        
      
      
      
        
          
          
          <a id="m-blog20180826the-fourth-dubbo-meetup-has-been-held-in-chengdu" href="/blog/2018/08/26/the-fourth-dubbo-meetup-has-been-held-in-chengdu/">The fourth Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-basic-usage-dubbo-consumer-configuration" href="/blog/2018/08/14/dubbo-basic-usage-dubbo-consumer-configuration/">Dubbo Consumer Configuration</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-several-ways-about-synchronousasynchronous-invoke" href="/blog/2018/08/14/dubbo-several-ways-about-synchronous/asynchronous-invoke/">Dubbo Invoke</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814dubbo-basic-usage-dubbo-provider-configuration" href="/blog/2018/08/14/dubbo-basic-usage-dubbo-provider-configuration/">Dubbo Provider Configuration</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814manipulating-services-dynamically-via-qos" href="/blog/2018/08/14/manipulating-services-dynamically-via-qos/">Dubbo QoS Introduction</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814source-code-analysis-of-spring-boot-dubbo-app-start-and-stop" href="/blog/2018/08/14/source-code-analysis-of-spring-boot-dubbo-app-start-and-stop/">Dubbo start/stop in spring boot</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814implementation-of-cross-language-calls-by-dubbo2js" href="/blog/2018/08/14/implementation-of-cross-language-calls-by-dubbo2.js/">dubbo2.js introduction</a>
        
      
      
      
        
          
          
          <a id="m-blog20180814generic-invoke-of-dubbo" href="/blog/2018/08/14/generic-invoke-of-dubbo/">Generic invoke</a>
        
      
      
      
        
          
          
          <a id="m-blog20180810dubbos-load-balance" href="/blog/2018/08/10/dubbos-load-balance/">Dubbo&#39;s Load Balance</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807use-annotations-in-dubbo" href="/blog/2018/08/07/use-annotations-in-dubbo/">Use Annotations In Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807using-zookeeper-in-dubbo" href="/blog/2018/08/07/using-zookeeper-in-dubbo/">Using Zookeeper in Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180807dubbo-101" href="/blog/2018/08/07/dubbo-101/">Your First Dubbo Demo</a>
        
      
      
      
        
          
          
          <a id="m-blog20180730the-third-dubbo-meetup-has-been-held-in-shenzhen" href="/blog/2018/07/30/the-third-dubbo-meetup-has-been-held-in-shenzhen/">The third Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180727sentinel-the-flow-sentinel-of-dubbo-services" href="/blog/2018/07/27/sentinel-the-flow-sentinel-of-dubbo-services/">Introduce sentinel</a>
        
      
      
      
        
          
          
          <a id="m-blog20180712tracking-with-pinpoint" href="/blog/2018/07/12/tracking-with-pinpoint/">Tracking with Pinpoint</a>
        
      
      
      
        
          
          
          <a id="m-blog20180701your-first-dubbo-filter" href="/blog/2018/07/01/your-first-dubbo-filter/">Your First Dubbo Filter</a>
        
      
      
      
        
          
          
          <a id="m-blog20180623the-second-dubbo-shanghai-meetup-has-been-held-successfully" href="/blog/2018/06/23/the-second-dubbo-shanghai-meetup-has-been-held-successfully/">The second Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180512the-first-dubbo-meetup-has-been-held-in-beijing" href="/blog/2018/05/12/the-first-dubbo-meetup-has-been-held-in-beijing/">The first Dubbo meetup</a>
        
      
      
      
        
          
          
          <a id="m-blog20180502the-apachecon-na-schedule-has-been-announced" href="/blog/2018/05/02/the-apachecon-na-schedule-has-been-announced/">ApacheCon NA</a>
        
      
      
      
        
          
          
          <a id="m-blog20180425the-gsocgoogle-summer-of-code-2018" href="/blog/2018/04/25/the-gsocgoogle-summer-of-code-2018/">GSoC 2018</a>
        
      
      
      
        
          
          
          <a id="m-blog20180422dubbo-roadmap-is-announced-in-qcon-beijing-2018" href="/blog/2018/04/22/dubbo-roadmap-is-announced-in-qcon-beijing-2018/">QCon Beijing 2018</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/blog/releases/" >Releases</a>
  </li>
  <ul>
    <li class="collapse " id="blogreleases">
      
      
      
      
        
          
          
          <a id="m-blog20200518past-releases" href="/blog/2020/05/18/past-releases/">Past Releases</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

</div>

<script>
  $(function() {
    $("#sidebarConsoleBtn").click(function () {
      $("#sidebarContent").toggle();
    });
  });
</script>



  </div>
  <div class="col-md-2 blogDocToc">
    






<div class="td-page-meta">






<a href="https://github.com/nacos-group/nacos-group.github.io/issues/new?title=How%20to%20implement%20a%20fully%20asynchronous%20calls%20chain%20based%20on%20Dubbo" target="_blank"><i class="fa fa-github fa-fw"></i> Create documentation issue</a>


<a href="https://github.com/alibaba/nacos/issues/new" target="_blank"><i class="fa fa-tasks fa-fw"></i> Create project issue</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#asynchronous-mode-before-version-26x">Asynchronous mode before version 2.6.x</a></li>
    <li><a href="#enhancement-based-on-completablefuture-in-version-270">Enhancement based on CompletableFuture in version 2.7.0</a></li>
    <li><a href="#example-1completablefuture-interface">example 1：CompletableFuture interface</a></li>
    <li><a href="#example-2synchronous-interface-uses-annotation-processor">Example 2：Synchronous interface uses Annotation Processor</a></li>
    <li><a href="#example-3use-asynccontext">Example 3：Use AsyncContext</a></li>
    <li><a href="#new-problems-resulted-from-asynchronization">New problems resulted from asynchronization</a>
      <ul>
        <li><a href="#filter-chain">Filter Chain</a></li>
        <li><a href="#context-passing">Context passing</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </div>
  <div class="row">
    <div class="col-md-2">
    </div>
    <div class="col-md-8 blogDocContent">
      <main role="main">
        <a class="btn btn-lg rssIcon" href="/blog/news/index.xml"
           target="_blank">
          RSS <i class="fa fa-rss ml-2 "></i>
        </a>
        


<div class="row">
  <div class="col-md-2">
    <ul>
      
    </ul>
  </div>
  <div class="col-md-10">
    
  </div>
</div>
<div class="td-content">
  <h1>How to implement a fully asynchronous calls chain based on Dubbo</h1>
  
  <div class="lead">This article recalls how asynchronous call is implemented in Dubbo 2.6.x, and introduces the new way based on CompletableFuture in 2.7.0.</div>
  
  <div class="td-byline mb-4">
    <time datetime="2018-09-02" class="text-muted">Sunday, September 02, 2018</time>
  </div>
  
  <p>Implementing the full asynchronous programming based on Dubbo, which is a new feature introduced in version 2.7.0 after the enhancement of the existing asynchronous mode.This article first reviews the supported functions and existing problems of asynchronization in 2.6.x and earlier versions, and introduces the targeted enhancements based on CompletableFuture in version 2.7.0. Then, the use of enhanced asynchronous programming is elaborated through several examples. Finally, it summarizes the new problems brought by the introduction of asynchronous mode and corresponding solutions from Dubbo. By reading this article, it is easy to implement a fully asynchronous remote service call chain based on Dubbo 2.7.0+.</p>
<h2 id="asynchronous-mode-before-version-26x">Asynchronous mode before version 2.6.x</h2>
<p>Dubbo Provides some asynchronous programming capabilities in 2.6.x and earlier versions, including <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/async-call.html">Asynchronous Call</a>, <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/callback-parameter.html">Parameter Callback</a> and <a href="http://dubbo.apache.org/zh-cn/docs/user/demos/events-notify.html">Event Notification</a> on Consumer side. There are some brief introductions to the usage and Demo in the above document links.</p>
<p>But the current asynchronous method has the following problems:</p>
<ul>
<li>Methods to access Future object are not direct enough.</li>
<li>Future interface cannot implement automatic callback. Customized ResponseFuture class could implement callback, however it only supports limited asynchronous scenes. For example, it does not support mutual coordination or combination between Future objects.</li>
<li>Asynchronization on Provider side is not supported.</li>
</ul>
<p>Take the asynchronous method of Consumer side as an example:</p>
<ol>
<li>Define a original synchronous interface and add the declaration to support asynchronous calls.</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">FooService</span> <span style="color:#719e07">{</span>
    String <span style="color:#268bd2">findFoo</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;fooService&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.foo.FooService&#34;</span><span style="color:#268bd2">&gt;</span>
      <span style="color:#268bd2">&lt;dubbo:method</span> name=<span style="color:#2aa198">&#34;findFoo&#34;</span> async=<span style="color:#2aa198">&#34;true&#34;</span> <span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;/dubbo:reference&gt;</span>
</code></pre></div><ol start="2">
<li>Obtain Future object through RpcContext.</li>
</ol>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#586e75">// this call will return null immediately
</span><span style="color:#586e75"></span>fooService<span style="color:#719e07">.</span>findFoo<span style="color:#719e07">(</span>fooId<span style="color:#719e07">);</span>
<span style="color:#586e75">// Obtain the Future instance. When the result is returned, Future instance will be notified and the result will be set to Future instance.
</span><span style="color:#586e75"></span>Future<span style="color:#719e07">&lt;</span>Foo<span style="color:#719e07">&gt;</span> fooFuture <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>getContext<span style="color:#719e07">().</span>getFuture<span style="color:#719e07">();</span>
fooFuture<span style="color:#719e07">.</span>get<span style="color:#719e07">();</span>
</code></pre></div><p>or</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#586e75">// this call will return null immediately
</span><span style="color:#586e75"></span>fooService<span style="color:#719e07">.</span>findFoo<span style="color:#719e07">(</span>fooId<span style="color:#719e07">);</span>
<span style="color:#586e75">// get Dubbo&#39;s built-in ResponseFuture, and set the callback
</span><span style="color:#586e75"></span>ResponseFuture future <span style="color:#719e07">=</span> <span style="color:#719e07">((</span>FutureAdapter<span style="color:#719e07">)</span>RpcContext<span style="color:#719e07">.</span>getContext<span style="color:#719e07">().</span>getFuture<span style="color:#719e07">()).</span>getFuture<span style="color:#719e07">();</span>
future<span style="color:#719e07">.</span>setCallback<span style="color:#719e07">(</span><span style="color:#719e07">new</span> ResponseCallback<span style="color:#719e07">()</span> <span style="color:#719e07">{</span>
    <span style="color:#268bd2">@Override</span>
    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">done</span><span style="color:#719e07">(</span>Object response<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>print<span style="color:#719e07">(</span>response<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>

    <span style="color:#268bd2">@Override</span>
    <span style="color:#268bd2">public</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">caught</span><span style="color:#719e07">(</span>Throwable exception<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        exception<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">});</span>
</code></pre></div><p>From this simple example, we can see there are some inconveniences in use:</p>
<ol>
<li>The synchronization interface of findFoo cannot directly return a Future object representing the asynchronous result, which is further obtained through RpcContext.</li>
<li>Future object can only be obtained from get method that will block until getting the result.</li>
<li>Callback can be set by getting the built-in ResponseFuture interface. However, the API to obtain ResponseFuture is not convenient enough to support other asynchronous scenes except callback. For example, it does not support the scene where multiple Future objects work together.</li>
</ol>
<h2 id="enhancement-based-on-completablefuture-in-version-270">Enhancement based on CompletableFuture in version 2.7.0</h2>
<p>People who understand the evolution history of Future in Java should know that the Future used in Dubbo 2.6.x and earlier versions is introduced in Java 5, so there are some problems in function design.The CompletableFuture introduced in Java 8 further enriches the Future interface and solves these problems well.</p>
<p>Support for Java 8 has been upgraded in Dubbo 2.7.0, and Dubbo has enhanced the current asynchronous functionality based on CompletableFuture.</p>
<ol>
<li>
<p>Now it supports direct definition of service interfaces that return CompletableFuture. Through these interfaces, we can implement asynchronous programming on both Consumer side and Provider side more naturally.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div></li>
<li>
<p>If you don&rsquo;t want to define the return value of the interface as a Future object, or if there is a defined synchronization interface, you can additionally define an asynchronous interface and provide a method to return a Future object.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">@AsyncFor</span><span style="color:#719e07">(</span>AsyncService<span style="color:#719e07">.</span>class<span style="color:#719e07">)</span>
<span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">GrettingServiceAsync</span> <span style="color:#268bd2">extends</span> GreetingsService <span style="color:#719e07">{</span>
    CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHiAsync</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>In this way, Provider can only implement the sayHi method. The Consumer can get a Future instance by directly calling sayHiAsync, and Dubbo framework will convert it to a call to the sayHi method on the Provider side automatically.</p>
<p>Providing an asynchronous method definition for each synchronization method can be inconvenient. Further, using <a href="https://github.com/dubbo/dubbo-async-processor">Annotation Processor implementation</a> in the Dubbo ecosystem can automatically generate asynchronous method definitions for us.</p>
</li>
<li>
<p>Similarly, if your original interface definition doesn&rsquo;t return a Future object, the Provider side also provides a programming interface similar to the Async Servlet in Servlet 3.0 to support asynchronization : <code>RpcContext.startAsync()</code>.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    String <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncServiceImpl</span> <span style="color:#268bd2">implements</span> AsyncService <span style="color:#719e07">{</span>
    <span style="color:#268bd2">public</span> String <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#268bd2">final</span> AsyncContext asyncContext <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>startAsync<span style="color:#719e07">();</span>
        <span style="color:#719e07">new</span> Thread<span style="color:#719e07">(()</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            asyncContext<span style="color:#719e07">.</span>write<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Hello &#34;</span> <span style="color:#719e07">+</span> name <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;, response from provider.&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#719e07">}).</span>start<span style="color:#719e07">();</span>
        <span style="color:#719e07">return</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>At the beginning of the method body, it starts asynchronization by running <code>RpcContext.startAsync()</code> , and it starts a new thread to execute the business logic asynchronously. After the time-consuming operation is completed, the result is written back by <code>asyncContext.write</code>.</p>
</li>
<li>
<p>RpcContext returns CompletableFuture directly.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> f <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>getContext<span style="color:#719e07">().</span>getCompletableFuture<span style="color:#719e07">();</span>
</code></pre></div></li>
</ol>
<p>All of the above enhancements are based on the compatibility with existing asynchronous programming, so asynchronous programs written based on 2.6.x versions can be successfully compiled without any modification.</p>
<p>Next, let&rsquo;s illustrate how to implement a fully asynchronous Dubbo service call chain through a few examples.</p>
<h2 id="example-1completablefuture-interface">example 1：CompletableFuture interface</h2>
<p>CompletableFuture interface can be used both for a synchronous call and for an asynchronous call on Consumer or Provider side. This example implements asynchronous calls between Consumer and Provider sides. Code link <a href="https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-original-future">dubbo-samples-async-original-future</a>.</p>
<ol>
<li>
<p>Interface definition</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>Note that the return type of this interface is <code>CompletableFuture&lt;String&gt;</code>.</p>
</li>
<li>
<p>Provider Side</p>
<ul>
<li>
<p>Implementation</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncServiceImpl</span> <span style="color:#268bd2">implements</span> AsyncService <span style="color:#719e07">{</span>
    <span style="color:#268bd2">public</span> CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> CompletableFuture<span style="color:#719e07">.</span>supplyAsync<span style="color:#719e07">(()</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                Thread<span style="color:#719e07">.</span>sleep<span style="color:#719e07">(</span>5000<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>InterruptedException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                e<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
            <span style="color:#719e07">}</span>
            <span style="color:#719e07">return</span> <span style="color:#2aa198">&#34;async response from provider.&#34;</span><span style="color:#719e07">;</span>
        <span style="color:#719e07">});</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>We can see that the business code is switched to be executed in the new thread by supplyAsync, so the Provider side is asynchronous.</p>
</li>
<li>
<p>Config</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;bean</span> id=<span style="color:#2aa198">&#34;asyncService&#34;</span> class=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.impl.AsyncServiceImpl&#34;</span><span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;dubbo:service</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span> ref=<span style="color:#2aa198">&#34;asyncService&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>The Config is the same as the original interface.</p>
</li>
</ul>
</li>
<li>
<p>Consumer Side</p>
<ul>
<li>Config</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;asyncService&#34;</span> timeout=<span style="color:#2aa198">&#34;10000&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>The Config is the same as the original interface.</p>
<ul>
<li>Call remote service</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">main</span><span style="color:#719e07">(</span>String<span style="color:#719e07">[]</span> args<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> Exception <span style="color:#719e07">{</span>
        ClassPathXmlApplicationContext context <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ClassPathXmlApplicationContext<span style="color:#719e07">(</span><span style="color:#719e07">new</span> String<span style="color:#719e07">[]{</span><span style="color:#2aa198">&#34;META-INF/spring/async-consumer.xml&#34;</span><span style="color:#719e07">});</span>
        context<span style="color:#719e07">.</span>start<span style="color:#719e07">();</span>
        <span style="color:#268bd2">final</span> AsyncService asyncService <span style="color:#719e07">=</span> <span style="color:#719e07">(</span>AsyncService<span style="color:#719e07">)</span> context<span style="color:#719e07">.</span>getBean<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;asyncService&#34;</span><span style="color:#719e07">);</span>
       
        CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> future <span style="color:#719e07">=</span> asyncService<span style="color:#719e07">.</span>sayHello<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;async call request&#34;</span><span style="color:#719e07">);</span>
        future<span style="color:#719e07">.</span>whenComplete<span style="color:#719e07">((</span>v<span style="color:#719e07">,</span> t<span style="color:#719e07">)</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>t <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                t<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
                System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Response: &#34;</span> <span style="color:#719e07">+</span> v<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">});</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Executed before response return.&#34;</span><span style="color:#719e07">);</span>
        System<span style="color:#719e07">.</span>in<span style="color:#719e07">.</span>read<span style="color:#719e07">();</span>
    <span style="color:#719e07">}</span>
</code></pre></div><p><code>CompletableFuture&lt;String&gt; future = asyncService.sayHello(&quot;async call request&quot;);</code>It is convenient to return the Future instance, which implements the asynchronous service call on the Consumer side.</p>
</li>
</ol>
<h2 id="example-2synchronous-interface-uses-annotation-processor">Example 2：Synchronous interface uses Annotation Processor</h2>
<p>This example demonstrates how to implement the Consumer-side asynchronous service call using the Annotation Processor based on the original synchronous interface. Code link <a href="https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-generated-future">dubbo-samples-async-generated-future</a>.</p>
<ol>
<li>
<p>Interface definition</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">@DubboAsync</span>
<span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">GreetingsService</span> <span style="color:#719e07">{</span>
    String <span style="color:#268bd2">sayHi</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>This is a generic definition of the Dubbo service interface. Note that add the @DubboAsync annotation when using Annotation Processor.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dependency&gt;</span>
    <span style="color:#268bd2">&lt;groupId&gt;</span>com.alibaba<span style="color:#268bd2">&lt;/groupId&gt;</span>
    <span style="color:#268bd2">&lt;artifactId&gt;</span>dubbo-async-processer<span style="color:#268bd2">&lt;/artifactId&gt;</span>
    <span style="color:#268bd2">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color:#268bd2">&lt;/version&gt;</span>
<span style="color:#268bd2">&lt;/dependency&gt;</span>
<span style="color:#268bd2">&lt;plugin&gt;</span>
    <span style="color:#268bd2">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#268bd2">&lt;/groupId&gt;</span>
    <span style="color:#268bd2">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#268bd2">&lt;/artifactId&gt;</span>
    <span style="color:#268bd2">&lt;version&gt;</span>3.7.0<span style="color:#268bd2">&lt;/version&gt;</span>
    <span style="color:#268bd2">&lt;configuration&gt;</span>
        <span style="color:#268bd2">&lt;source&gt;</span>1.8<span style="color:#268bd2">&lt;/source&gt;</span>
        <span style="color:#268bd2">&lt;target&gt;</span>1.8<span style="color:#268bd2">&lt;/target&gt;</span>
        <span style="color:#268bd2">&lt;annotationProcessorPaths&gt;</span>
            <span style="color:#268bd2">&lt;path&gt;</span>
                <span style="color:#268bd2">&lt;groupId&gt;</span>com.alibaba<span style="color:#268bd2">&lt;/groupId&gt;</span>
                <span style="color:#268bd2">&lt;artifactId&gt;</span>dubbo-async-processer<span style="color:#268bd2">&lt;/artifactId&gt;</span>
                <span style="color:#268bd2">&lt;version&gt;</span>1.0.0-SNAPSHOT<span style="color:#268bd2">&lt;/version&gt;</span>
            <span style="color:#268bd2">&lt;/path&gt;</span>
        <span style="color:#268bd2">&lt;/annotationProcessorPaths&gt;</span>
    <span style="color:#268bd2">&lt;/configuration&gt;</span>
<span style="color:#268bd2">&lt;/plugin&gt;</span>
</code></pre></div><p>The above config is the Maven dependency that imports dubbo-async-processer processor. Developers who define interfaces (providing APIs) usually add the above dependencies to the project, so that when doing API packaging, the following interface definitions will be automatically generated in APIs:</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#586e75">/**
</span><span style="color:#586e75">* Generated by dubbo-async-processer
</span><span style="color:#586e75">*/</span>
<span style="color:#719e07">package</span> com.alibaba.dubbo.samples.api<span style="color:#719e07">;</span>
<span style="color:#719e07">import</span> java.util.concurrent.CompletableFuture<span style="color:#719e07">;</span>
<span style="color:#268bd2">@javax.annotation.Generated</span><span style="color:#719e07">(</span><span style="color:#2aa198">&#34;com.alibaba.dubbo.async.processor.AsyncAnnotationProcessor&#34;</span><span style="color:#719e07">)</span>
<span style="color:#268bd2">@org.apache.dubbo.common.config.AsyncFor</span><span style="color:#719e07">(</span>com<span style="color:#719e07">.</span>alibaba<span style="color:#719e07">.</span>dubbo<span style="color:#719e07">.</span>samples<span style="color:#719e07">.</span>api<span style="color:#719e07">.</span>GreetingsService<span style="color:#719e07">.</span>class<span style="color:#719e07">)</span>
<span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">GreetingsServiceAsync</span> <span style="color:#268bd2">extends</span> GreetingsService <span style="color:#719e07">{</span>
CompletableFuture<span style="color:#719e07">&lt;</span>java<span style="color:#719e07">.</span>lang<span style="color:#719e07">.</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHiAsync</span><span style="color:#719e07">(</span>java<span style="color:#719e07">.</span>lang<span style="color:#719e07">.</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div></li>
<li>
<p>Provider side</p>
<ul>
<li>Config</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;bean</span> id=<span style="color:#2aa198">&#34;greetingsService&#34;</span> class=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.impl.GreetingsServiceImpl&#34;</span><span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;dubbo:service</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.api.GreetingsService&#34;</span> ref=<span style="color:#2aa198">&#34;greetingsService&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><ul>
<li>Service implementation</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">GreetingsServiceImpl</span> <span style="color:#268bd2">implements</span> GreetingsService <span style="color:#719e07">{</span>
    <span style="color:#268bd2">@Override</span>
    <span style="color:#268bd2">public</span> String <span style="color:#268bd2">sayHi</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> <span style="color:#2aa198">&#34;hi, &#34;</span> <span style="color:#719e07">+</span> name<span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div></li>
<li>
<p>Consumer side</p>
<ul>
<li>Config</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"> <span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;greetingsService&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.api.GreetingsServiceAsync&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>Note that the service interface uses <strong>GreetingsServiceAsync</strong></p>
<ul>
<li>Service call</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">main</span><span style="color:#719e07">(</span>String<span style="color:#719e07">[]</span> args<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> Exception <span style="color:#719e07">{</span>
        ClassPathXmlApplicationContext context <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ClassPathXmlApplicationContext<span style="color:#719e07">(</span><span style="color:#719e07">new</span> String<span style="color:#719e07">[]{</span><span style="color:#2aa198">&#34;META-INF/spring/async-consumer.xml&#34;</span><span style="color:#719e07">});</span>
        context<span style="color:#719e07">.</span>start<span style="color:#719e07">();</span>
   
        GreetingsServiceAsync greetingsService <span style="color:#719e07">=</span> <span style="color:#719e07">(</span>GreetingsServiceAsync<span style="color:#719e07">)</span> context<span style="color:#719e07">.</span>getBean<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;greetingsService&#34;</span><span style="color:#719e07">);</span>
        CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> future <span style="color:#719e07">=</span> greetingsService<span style="color:#719e07">.</span>sayHiAsync<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;async call reqeust&#34;</span><span style="color:#719e07">);</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;async call ret :&#34;</span> <span style="color:#719e07">+</span> future<span style="color:#719e07">.</span>get<span style="color:#719e07">());</span>
        
        System<span style="color:#719e07">.</span>in<span style="color:#719e07">.</span>read<span style="color:#719e07">();</span>
    <span style="color:#719e07">}</span>
</code></pre></div><p>In this way, we can use <code>CompletableFuture&lt;String&gt; future = greetingsService.sayHiAsync(&quot;async call reqeust&quot;);</code> directly，and return CompletableFuture.</p>
</li>
</ol>
<h2 id="example-3use-asynccontext">Example 3：Use AsyncContext</h2>
<p>This example demonstrates how to implement the Provider-side asynchronous execution through AsyncContext based on the original synchronous interface. Code link <a href="https://github.com/apache/dubbo-samples/tree/master/dubbo-samples-async/dubbo-samples-async-provider">dubbo-samples-async-provider</a>.</p>
<ol>
<li>
<p>Interface definition</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">interface</span> <span style="color:#268bd2">AsyncService</span> <span style="color:#719e07">{</span>
    String <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>
</code></pre></div></li>
<li>
<p>Provider side</p>
<ul>
<li>Config</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;bean</span> id=<span style="color:#2aa198">&#34;asyncService&#34;</span> class=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.impl.AsyncServiceImpl&#34;</span><span style="color:#268bd2">/&gt;</span>
<span style="color:#268bd2">&lt;dubbo:service</span> async=<span style="color:#2aa198">&#34;true&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span> ref=<span style="color:#2aa198">&#34;asyncService&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><p>Note that adding <code>async=&quot;true&quot;</code> indicates that this is a service that starts the Provider-side execution asynchronously.</p>
<ul>
<li>Asynchronous execution implementation</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncServiceImpl</span> <span style="color:#268bd2">implements</span> AsyncService <span style="color:#719e07">{</span>
    <span style="color:#268bd2">public</span> String <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#268bd2">final</span> AsyncContext asyncContext <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>startAsync<span style="color:#719e07">();</span>
        <span style="color:#719e07">new</span> Thread<span style="color:#719e07">(()</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            asyncContext<span style="color:#719e07">.</span>signalContextSwitch<span style="color:#719e07">();</span>
            <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                Thread<span style="color:#719e07">.</span>sleep<span style="color:#719e07">(</span>500<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>InterruptedException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                e<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
            <span style="color:#719e07">}</span>
            asyncContext<span style="color:#719e07">.</span>write<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Hello &#34;</span> <span style="color:#719e07">+</span> name <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;, response from provider.&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#719e07">}).</span>start<span style="color:#719e07">();</span>
        <span style="color:#719e07">return</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div></li>
<li>
<p>Consumer side</p>
<ul>
<li>Config</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#268bd2">&lt;dubbo:reference</span> id=<span style="color:#2aa198">&#34;asyncService&#34;</span> interface=<span style="color:#2aa198">&#34;com.alibaba.dubbo.samples.async.api.AsyncService&#34;</span><span style="color:#268bd2">/&gt;</span>
</code></pre></div><ul>
<li>Service call</li>
</ul>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">void</span> <span style="color:#268bd2">main</span><span style="color:#719e07">(</span>String<span style="color:#719e07">[]</span> args<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> Exception <span style="color:#719e07">{</span>
        ClassPathXmlApplicationContext context <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ClassPathXmlApplicationContext<span style="color:#719e07">(</span><span style="color:#719e07">new</span> String<span style="color:#719e07">[]{</span><span style="color:#2aa198">&#34;META-INF/spring/async-consumer.xml&#34;</span><span style="color:#719e07">});</span>
        context<span style="color:#719e07">.</span>start<span style="color:#719e07">();</span>
   
        AsyncService asyncService <span style="color:#719e07">=</span> <span style="color:#719e07">(</span>AsyncService<span style="color:#719e07">)</span> context<span style="color:#719e07">.</span>getBean<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;asyncService&#34;</span><span style="color:#719e07">);</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span>asyncService<span style="color:#719e07">.</span>sayHello<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;async call request&#34;</span><span style="color:#719e07">));</span>
        
        System<span style="color:#719e07">.</span>in<span style="color:#719e07">.</span>read<span style="color:#719e07">();</span>
    <span style="color:#719e07">}</span>
</code></pre></div></li>
</ol>
<h2 id="new-problems-resulted-from-asynchronization">New problems resulted from asynchronization</h2>
<h3 id="filter-chain">Filter Chain</h3>
<p>The following is a complete Filter chain for a normal Dubbo call.</p>
<p>After using the asynchronous call, since the asynchronous result is executed separately in the asynchronous thread, the Result passed through the second half of the Filter chain is null, and the real result cannot be processed by the Filter chain when it is returned.</p>
<p>In order to solve this problem, PostProcessFilter and AbstractPostProcessFilter were introduced in Dubbo 2.7.0. The PostProcessFilter interface extends from the Filter interface, and AbstractPostProcessFilter is an abstract implementation of PostProcessFilter.</p>
<p>The following is an example of extending the Filter and supporting the asynchronous Filter chain.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">@Activate</span><span style="color:#719e07">(</span>group <span style="color:#719e07">=</span> <span style="color:#719e07">{</span>Constants<span style="color:#719e07">.</span>PROVIDER<span style="color:#719e07">,</span> Constants<span style="color:#719e07">.</span>CONSUMER<span style="color:#719e07">})</span>
<span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncPostprocessFilter</span> <span style="color:#268bd2">extends</span> AbstractPostProcessFilter <span style="color:#719e07">{</span>

    <span style="color:#268bd2">@Override</span>
    <span style="color:#268bd2">public</span> Result <span style="color:#268bd2">invoke</span><span style="color:#719e07">(</span>Invoker<span style="color:#719e07">&lt;?&gt;</span> invoker<span style="color:#719e07">,</span> Invocation invocation<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> RpcException <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> postProcessResult<span style="color:#719e07">(</span>invoker<span style="color:#719e07">.</span>invoke<span style="color:#719e07">(</span>invocation<span style="color:#719e07">),</span> invoker<span style="color:#719e07">,</span> invocation<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>

    <span style="color:#268bd2">@Override</span>
    <span style="color:#268bd2">protected</span> Result <span style="color:#268bd2">doPostProcess</span><span style="color:#719e07">(</span>Result result<span style="color:#719e07">,</span> Invoker<span style="color:#719e07">&lt;?&gt;</span> invoker<span style="color:#719e07">,</span> Invocation invocation<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        System<span style="color:#719e07">.</span>out<span style="color:#719e07">.</span>println<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Filter get the return value: &#34;</span> <span style="color:#719e07">+</span> result<span style="color:#719e07">.</span>getValue<span style="color:#719e07">());</span>
        <span style="color:#719e07">return</span> result<span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><h3 id="context-passing">Context passing</h3>
<p>Currently, the context we are considering mainly refers to the data stored in the RpcContext. In most scenarios, the user needs to complete the passing of the Context before switching the service thread.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncServiceImpl</span> <span style="color:#268bd2">implements</span> AsyncService <span style="color:#719e07">{</span>
    <span style="color:#586e75">// Save the context of the current thread
</span><span style="color:#586e75"></span>    RpcContext context <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>getContext<span style="color:#719e07">();</span>
    <span style="color:#268bd2">public</span> CompletableFuture<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> CompletableFuture<span style="color:#719e07">.</span>supplyAsync<span style="color:#719e07">(()</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// Set context into new thread
</span><span style="color:#586e75"></span>            RpcContext<span style="color:#719e07">.</span>setContext<span style="color:#719e07">(</span>context<span style="color:#719e07">);</span>
            <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                Thread<span style="color:#719e07">.</span>sleep<span style="color:#719e07">(</span>5000<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>InterruptedException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                e<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
            <span style="color:#719e07">}</span>
            <span style="color:#719e07">return</span> <span style="color:#2aa198">&#34;async response from provider.&#34;</span><span style="color:#719e07">;</span>
        <span style="color:#719e07">});</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>However, AsyncContext also provides the signalContextSwitch() method for a convenient Context switch.</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">AsyncServiceImpl</span> <span style="color:#268bd2">implements</span> AsyncService <span style="color:#719e07">{</span>
    <span style="color:#268bd2">public</span> String <span style="color:#268bd2">sayHello</span><span style="color:#719e07">(</span>String name<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#268bd2">final</span> AsyncContext asyncContext <span style="color:#719e07">=</span> RpcContext<span style="color:#719e07">.</span>startAsync<span style="color:#719e07">();</span>
        <span style="color:#719e07">new</span> Thread<span style="color:#719e07">(()</span> <span style="color:#719e07">-&gt;</span> <span style="color:#719e07">{</span>
            asyncContext<span style="color:#719e07">.</span>signalContextSwitch<span style="color:#719e07">();</span>
            <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
                Thread<span style="color:#719e07">.</span>sleep<span style="color:#719e07">(</span>500<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>InterruptedException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                e<span style="color:#719e07">.</span>printStackTrace<span style="color:#719e07">();</span>
            <span style="color:#719e07">}</span>
            asyncContext<span style="color:#719e07">.</span>write<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Hello &#34;</span> <span style="color:#719e07">+</span> name <span style="color:#719e07">+</span> <span style="color:#2aa198">&#34;, response from provider.&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#719e07">}).</span>start<span style="color:#719e07">();</span>
        <span style="color:#719e07">return</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div>
  
  
</div>


      </main>
    </div>
    <div class="col-md-2">
    </div>
  </div>
  
</section>

  

<footer id="footer" role="contentinfo">
  <div class="container">
    <img src="/images/nacos_gray.png"/>
    <div class="row">
      <div class="col-md-6"><h3>Vision</h3>
        <p>By providing an easy-to-use service infrastructure such as dynamic service
            discovery, service configuration, service sharing and management and etc., Nacos help users better
            construct, deliver and manage their own service platform, reuse and composite business service
            faster and deliver value of business innovation more quickly so as to win market for users in the
            era of cloud native and in all cloud environments, such as private, mixed, or public clouds.</p></div>
      <div class="col-md-3">
        <dl>
          <dt>Documentation</dt>
          
          <dd><a href="/en-us/docs/what-is-nacos.html" target="_self">Overview</a></dd>
          
          <dd><a href="/en-us/docs/quick-start.html" target="_self">Quick start</a></dd>
          
          <dd><a href="/en-us/docs/contributing.html" target="_self">Developer guide</a></dd>
          
        </dl>
      </div>
      <div class="col-md-3">
        <dl>
          <dt>Resources</dt>
          
          <dd><a href="/en-us/community/index.html" target="_self">Community</a></dd>
          
          <dd><a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_self">Cloud Service MSE</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">Cloud Service EDAS</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">Cloud Service AHAS</a></dd>
          
        </dl>
      </div>
    </div>
    <div class="col-md-12 text-center copyright">
      <span>© 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span>
    </div>
  </div>
</footer>


</body>
<script type="text/javascript">
  ;(function () {
    $('#fh5co-header').addClass('navbar-fixed-top fh5co-animated slideInDown');
    $('#nacosLogo').attr("src", "/images/nacos_colorful.png")
  }());
</script>
</html>