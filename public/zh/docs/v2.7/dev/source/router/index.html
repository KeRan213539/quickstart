<!DOCTYPE html>






<html lang="zh">
<head>
  

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title> 服务路由</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    
    <meta http-equiv="content-language" content="zh-cn" />

  

    
    
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Nacos">
    <meta property="og:title" content="服务路由">
    <meta property="og:url" content="/zh/docs/v2.7/dev/source/router/">
    <meta property="og:image" content="/images/">
    <meta name="twitter:title" content="Nacos" />
    <meta name="twitter:url" content="/zh/docs/v2.7/dev/source/router/" />
    <meta name="twitter:image" content="/images/" />
    <meta name="twitter:card" content="" />
    
    
    
    <link rel="canonical" href="/zh/docs/v2.7/dev/source/router/"/>

    


    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600,400italic,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="/css/leaflet.css" />

    
    <link rel="stylesheet" href="/css/animate.css">
    
    <link rel="stylesheet" href="/css/icomoon.css">
    
    <link rel="stylesheet" href="/css/simple-line-icons.css">
    
    <link rel="stylesheet" href="/css/magnific-popup.css">
    
    <link rel="stylesheet" href="/css/bootstrap.css">

    
    <link rel="stylesheet" href="/css/style.css">

    
    
    <link rel="stylesheet" href="/css/custom1.css">
    
    <link rel="stylesheet" href="/css/custom2.css">
    
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    

    
    <script src="/js/modernizr-2.6.2.min.js"></script>
    
    

  <meta name="referrer" content="no-referrer"/>
  <link rel="shortcut icon" href="https://img.alicdn.com/tfs/TB1hgJpHAPoK1RjSZKbXXX1IXXa-64-64.png"/>
  	
	<script src="/js/jquery.min.js"></script>
	
	<script src="/js/jquery.easing.1.3.js"></script>
	
	<script src="/js/bootstrap.min.js"></script>
	
	<script src="/js/jquery.waypoints.min.js"></script>
	
	<script src="/js/jquery.stellar.min.js"></script>
	
	<script src="/js/jquery.countTo.js"></script>
	
	<script src="/js/jquery.magnific-popup.min.js"></script>
	<script src="/js/magnific-popup-options.js"></script>
	


	
	<script src="/js/main.js"></script>

</head>
<body>


    <header role="banner" id="fh5co-header">
        <div class="container">
            
            <nav class="navbar navbar-default">
                <div class="navbar-header">
                    
                    <a href="#" class="js-fh5co-nav-toggle fh5co-nav-toggle" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><i></i></a>
                    <a class="navbar-brand" href="index.html"><img id="nacosLogo" src="/images/nacos.png"></a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                  <ul class="nav navbar-nav navbar-right">
                    
                    
                    
                    <li><a class="external" href="/"><span>首页</span></a></li>
                    
                    
                    

                    

                    

                    

                    

                    
                        <li class="active"><a class="external" href="/zh/docs"><span>文档</span></a></li>
                    
                        <li><a class="external" href="/zh/blog"><span>博客</span></a></li>
                    
                    <li>
                      

<div class="dropdown">
	<button class="btn btn-default dropdown-toggle" type="button" data-toggle="dropdown"
					aria-haspopup="true" aria-expanded="false" >
		中文
		<span class="caret"></span>
	</button>
	<ul class="dropdown-menu">
		
		<li><a class="external" href="/">English</a></li>
		
	</ul>
</div>
                    </li>
                </ul>
            </div>
        </nav>
        
    </div>
</header>

<section class="animated">
  <div class="col-md-2 blogDocSidebar">
    




<a href="#" id="sidebarConsoleBtn"><i class="fa fa-bars fa-fw"></i></a>
<div id="sidebarContent">
  
  






<ul>
  <li>
    <a href="/zh/docs/" >文档</a>
  </li>
  <ul>
    <li class="collapse show" id="zhdocs">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/" >Dubbo 2.7</a>
  </li>
  <ul>
    <li class="collapse show" id="zhdocsv27">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/" >用户文档</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27user">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/preface/" >入门</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userpreface">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userprefacebackground" href="/zh/docs/v2.7/user/preface/background/">背景</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userprefacerequirements" href="/zh/docs/v2.7/user/preface/requirements/">需求</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userprefacearchitecture" href="/zh/docs/v2.7/user/preface/architecture/">架构</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userprefaceusage" href="/zh/docs/v2.7/user/preface/usage/">用法</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27userquick-start" href="/zh/docs/v2.7/user/quick-start/">快速开始</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userdependencies" href="/zh/docs/v2.7/user/dependencies/">依赖</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27usermaturity" href="/zh/docs/v2.7/user/maturity/">成熟度</a>
        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/configuration/" >配置</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userconfiguration">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationxml" href="/zh/docs/v2.7/user/configuration/xml/">XML 配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationconfig-center" href="/zh/docs/v2.7/user/configuration/config-center/">动态配置中心</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationproperties" href="/zh/docs/v2.7/user/configuration/properties/">属性配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationenvironment-variables" href="/zh/docs/v2.7/user/configuration/environment-variables/">自动加载环境变量</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationapi" href="/zh/docs/v2.7/user/configuration/api/">API 配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationannotation" href="/zh/docs/v2.7/user/configuration/annotation/">注解配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userconfigurationconfiguration-load-process" href="/zh/docs/v2.7/user/configuration/configuration-load-process/">配置加载流程</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/examples/" >用法示例</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userexamples">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplespreflight-check" href="/zh/docs/v2.7/user/examples/preflight-check/">启动时检查</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesfault-tolerent-strategy" href="/zh/docs/v2.7/user/examples/fault-tolerent-strategy/">集群容错</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesloadbalance" href="/zh/docs/v2.7/user/examples/loadbalance/">负载均衡</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesthread-model" href="/zh/docs/v2.7/user/examples/thread-model/">线程模型</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesexplicit-target" href="/zh/docs/v2.7/user/examples/explicit-target/">直连提供者</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplessubscribe-only" href="/zh/docs/v2.7/user/examples/subscribe-only/">只订阅</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesmulti-protocols" href="/zh/docs/v2.7/user/examples/multi-protocols/">多协议</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesmulti-registry" href="/zh/docs/v2.7/user/examples/multi-registry/">多注册中心</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesservice-group" href="/zh/docs/v2.7/user/examples/service-group/">服务分组</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesstatic-service" href="/zh/docs/v2.7/user/examples/static-service/">静态服务</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesmulti-versions" href="/zh/docs/v2.7/user/examples/multi-versions/">多版本</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesgroup-merger" href="/zh/docs/v2.7/user/examples/group-merger/">分组聚合</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesparameter-validation" href="/zh/docs/v2.7/user/examples/parameter-validation/">参数验证</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesresult-cache" href="/zh/docs/v2.7/user/examples/result-cache/">结果缓存</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesgeneric-reference" href="/zh/docs/v2.7/user/examples/generic-reference/">使用泛化调用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesprotobuf-idl" href="/zh/docs/v2.7/user/examples/protobuf-idl/">Protobuf</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplespb-generic-reference" href="/zh/docs/v2.7/user/examples/pb-generic-reference/">Protobuf 泛化调用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesgeneric-service" href="/zh/docs/v2.7/user/examples/generic-service/">实现泛化调用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesecho-service" href="/zh/docs/v2.7/user/examples/echo-service/">回声测试</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplescontext" href="/zh/docs/v2.7/user/examples/context/">上下文信息</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesattachment" href="/zh/docs/v2.7/user/examples/attachment/">隐式参数</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesasync-execute-on-provider" href="/zh/docs/v2.7/user/examples/async-execute-on-provider/">异步执行</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesasync-call" href="/zh/docs/v2.7/user/examples/async-call/">异步调用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleslocal-call" href="/zh/docs/v2.7/user/examples/local-call/">本地调用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplescallback-parameter" href="/zh/docs/v2.7/user/examples/callback-parameter/">参数回调</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesevents-notify" href="/zh/docs/v2.7/user/examples/events-notify/">事件通知</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleslocal-stub" href="/zh/docs/v2.7/user/examples/local-stub/">本地存根</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleslocal-mock" href="/zh/docs/v2.7/user/examples/local-mock/">本地伪装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesdelay-publish" href="/zh/docs/v2.7/user/examples/delay-publish/">延迟暴露</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesconcurrency-control" href="/zh/docs/v2.7/user/examples/concurrency-control/">并发控制</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesconfig-connections" href="/zh/docs/v2.7/user/examples/config-connections/">连接控制</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleslazy-connect" href="/zh/docs/v2.7/user/examples/lazy-connect/">延迟连接</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesstickiness" href="/zh/docs/v2.7/user/examples/stickiness/">粘滞连接</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplestls" href="/zh/docs/v2.7/user/examples/tls/">TLS</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplestoken-authorization" href="/zh/docs/v2.7/user/examples/token-authorization/">令牌验证</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesrouting-rule" href="/zh/docs/v2.7/user/examples/routing-rule/">路由规则</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesrouting-rule-deprecated" href="/zh/docs/v2.7/user/examples/routing-rule-deprecated/">旧路由规则</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesconfig-rule" href="/zh/docs/v2.7/user/examples/config-rule/">配置规则</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesconfig-rule-deprecated" href="/zh/docs/v2.7/user/examples/config-rule-deprecated/">旧配置规则</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesservice-downgrade" href="/zh/docs/v2.7/user/examples/service-downgrade/">服务降级</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesconsumer-threadpool" href="/zh/docs/v2.7/user/examples/consumer-threadpool/">消费端线程池模型</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesgraceful-shutdown" href="/zh/docs/v2.7/user/examples/graceful-shutdown/">优雅停机</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleshostname-binding" href="/zh/docs/v2.7/user/examples/hostname-binding/">主机绑定</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesset-host" href="/zh/docs/v2.7/user/examples/set-host/">主机配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplessimplify-registry-data" href="/zh/docs/v2.7/user/examples/simplify-registry-data/">注册信息简化</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexampleslogger-strategy" href="/zh/docs/v2.7/user/examples/logger-strategy/">日志适配</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesaccesslog" href="/zh/docs/v2.7/user/examples/accesslog/">访问日志</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesservice-container" href="/zh/docs/v2.7/user/examples/service-container/">服务容器</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesreference-config-cache" href="/zh/docs/v2.7/user/examples/reference-config-cache/">ReferenceConfig 缓存</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userexamplesregistry-only" href="/zh/docs/v2.7/user/examples/registry-only/">只注册</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/references/" >参考手册</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userreferences">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/references/xml/" >XML 配置</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userreferencesxml">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-application" href="/zh/docs/v2.7/user/references/xml/dubbo-application/">dubbo:application</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-argument" href="/zh/docs/v2.7/user/references/xml/dubbo-argument/">dubbo:argument</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-config-center" href="/zh/docs/v2.7/user/references/xml/dubbo-config-center/">dubbo:config-center</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-consumer" href="/zh/docs/v2.7/user/references/xml/dubbo-consumer/">dubbo:consumer</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-method" href="/zh/docs/v2.7/user/references/xml/dubbo-method/">dubbo:method</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-module" href="/zh/docs/v2.7/user/references/xml/dubbo-module/">dubbo:module</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-monitor" href="/zh/docs/v2.7/user/references/xml/dubbo-monitor/">dubbo:monitor</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-parameter" href="/zh/docs/v2.7/user/references/xml/dubbo-parameter/">dubbo:parameter</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-protocol" href="/zh/docs/v2.7/user/references/xml/dubbo-protocol/">dubbo:protocol</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-provider" href="/zh/docs/v2.7/user/references/xml/dubbo-provider/">dubbo:provider</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-reference" href="/zh/docs/v2.7/user/references/xml/dubbo-reference/">dubbo:reference</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-registry" href="/zh/docs/v2.7/user/references/xml/dubbo-registry/">dubbo:registry</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesxmldubbo-service" href="/zh/docs/v2.7/user/references/xml/dubbo-service/">dubbo:service</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/references/protocol/" >协议参考手册</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userreferencesprotocol">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocoldubbo" href="/zh/docs/v2.7/user/references/protocol/dubbo/">dubbo://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolrest" href="/zh/docs/v2.7/user/references/protocol/rest/">rest://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolhttp" href="/zh/docs/v2.7/user/references/protocol/http/">http://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolhessian" href="/zh/docs/v2.7/user/references/protocol/hessian/">hessian://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolredis" href="/zh/docs/v2.7/user/references/protocol/redis/">redis://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolthrift" href="/zh/docs/v2.7/user/references/protocol/thrift/">thrift://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolgrpc" href="/zh/docs/v2.7/user/references/protocol/grpc/">grpc://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolmemcached" href="/zh/docs/v2.7/user/references/protocol/memcached/">memcached://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolrmi" href="/zh/docs/v2.7/user/references/protocol/rmi/">rmi://</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesprotocolwebservice" href="/zh/docs/v2.7/user/references/protocol/webservice/">webservice://</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/references/registry/" >注册中心参考手册</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userreferencesregistry">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesregistrynacos" href="/zh/docs/v2.7/user/references/registry/nacos/">Nacos</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesregistryzookeeper" href="/zh/docs/v2.7/user/references/registry/zookeeper/">Zookeeper</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesregistrymulticast" href="/zh/docs/v2.7/user/references/registry/multicast/">Multicast</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesregistryredis" href="/zh/docs/v2.7/user/references/registry/redis/">Redis</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesregistrysimple" href="/zh/docs/v2.7/user/references/registry/simple/">Simple</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesmetadata" href="/zh/docs/v2.7/user/references/metadata/">元数据参考手册</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesapi" href="/zh/docs/v2.7/user/references/api/">API 参考手册</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesqos" href="/zh/docs/v2.7/user/references/qos/">QOS 手册</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencestelnet" href="/zh/docs/v2.7/user/references/telnet/">Telnet 手册</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userreferencesmaven" href="/zh/docs/v2.7/user/references/maven/">Maven 插件参考手册</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/versions/" >版本升级</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userversions">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userversionsversion-270" href="/zh/docs/v2.7/user/versions/version-270/">2.7.0</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27userbest-practice" href="/zh/docs/v2.7/user/best-practice/">服务化最佳实践</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userrecommend" href="/zh/docs/v2.7/user/recommend/">推荐用法</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27usercapacity-plan" href="/zh/docs/v2.7/user/capacity-plan/">容量规划</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userperf-test" href="/zh/docs/v2.7/user/perf-test/">性能测试报告</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27usercoveragence" href="/zh/docs/v2.7/user/coveragence/">测试覆盖率报告</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userbenchmark-tool" href="/zh/docs/v2.7/user/benchmark-tool/">基准测试</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userrest" href="/zh/docs/v2.7/user/rest/">REST 支持</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27usersimple-monitor" href="/zh/docs/v2.7/user/simple-monitor/">简单监控</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userserialization" href="/zh/docs/v2.7/user/serialization/">Kryo 和 FST 序列化</a>
        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/languages/" >其他语言支持</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userlanguages">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/user/languages/erlang/" >Erlang</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27userlanguageserlang">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27userlanguageserlangquick-start" href="/zh/docs/v2.7/user/languages/erlang/quick-start/">快速开始</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userlanguageserlangreference" href="/zh/docs/v2.7/user/languages/erlang/reference/">消费者配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userlanguageserlangservice" href="/zh/docs/v2.7/user/languages/erlang/service/">提供者配置</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27userlanguageserlangserialization" href="/zh/docs/v2.7/user/languages/erlang/serialization/">序列化配置项</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27usernew-features-in-a-glance" href="/zh/docs/v2.7/user/new-features-in-a-glance/"></a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/dev/" >开发指南</a>
  </li>
  <ul>
    <li class="collapse show" id="zhdocsv27dev">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27devbuild" href="/zh/docs/v2.7/dev/build/">源码构建</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devdesign" href="/zh/docs/v2.7/dev/design/">框架设计</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devspi" href="/zh/docs/v2.7/dev/spi/">扩展点加载</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplementation" href="/zh/docs/v2.7/dev/implementation/">实现细节</a>
        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/dev/impls/" >SPI 扩展实现</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27devimpls">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsprotocol" href="/zh/docs/v2.7/dev/impls/protocol/">协议扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsfilter" href="/zh/docs/v2.7/dev/impls/filter/">调用拦截扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsinvoker-listener" href="/zh/docs/v2.7/dev/impls/invoker-listener/">引用监听扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsexporter-listener" href="/zh/docs/v2.7/dev/impls/exporter-listener/">暴露监听扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplscluster" href="/zh/docs/v2.7/dev/impls/cluster/">集群扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsrouter" href="/zh/docs/v2.7/dev/impls/router/">路由扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsload-balance" href="/zh/docs/v2.7/dev/impls/load-balance/">负载均衡扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsmerger" href="/zh/docs/v2.7/dev/impls/merger/">合并结果扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsregistry" href="/zh/docs/v2.7/dev/impls/registry/">注册中心扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsmonitor" href="/zh/docs/v2.7/dev/impls/monitor/">监控中心扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsextension-factory" href="/zh/docs/v2.7/dev/impls/extension-factory/">扩展点加载扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsproxy-factory" href="/zh/docs/v2.7/dev/impls/proxy-factory/">动态代理扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplscompiler" href="/zh/docs/v2.7/dev/impls/compiler/">编译器扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsconfig-center" href="/zh/docs/v2.7/dev/impls/config-center/">配置中心扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsdispatcher" href="/zh/docs/v2.7/dev/impls/dispatcher/">消息派发扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsthreadpool" href="/zh/docs/v2.7/dev/impls/threadpool/">线程池扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsserialize" href="/zh/docs/v2.7/dev/impls/serialize/">序列化扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsremoting" href="/zh/docs/v2.7/dev/impls/remoting/">网络传输扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsexchanger" href="/zh/docs/v2.7/dev/impls/exchanger/">信息交换扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsnetworker" href="/zh/docs/v2.7/dev/impls/networker/">组网扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplstelnet-handler" href="/zh/docs/v2.7/dev/impls/telnet-handler/">Telnet 命令扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsstatus-checker" href="/zh/docs/v2.7/dev/impls/status-checker/">状态检查扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplscontainer" href="/zh/docs/v2.7/dev/impls/container/">容器扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplscache" href="/zh/docs/v2.7/dev/impls/cache/">缓存扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplsvalidation" href="/zh/docs/v2.7/dev/impls/validation/">验证扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplslogger-adapter" href="/zh/docs/v2.7/dev/impls/logger-adapter/">日志适配扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devimplspage" href="/zh/docs/v2.7/dev/impls/page/"></a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/dev/principals/" >设计原则</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27devprincipals">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalscode-detail" href="/zh/docs/v2.7/dev/principals/code-detail/">魔鬼在细节</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsconfiguration" href="/zh/docs/v2.7/dev/principals/configuration/">配置设计</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsdummy" href="/zh/docs/v2.7/dev/principals/dummy/">防痴呆设计</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsexpansibility" href="/zh/docs/v2.7/dev/principals/expansibility/">谈谈扩充式扩展与增量式扩展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsextension" href="/zh/docs/v2.7/dev/principals/extension/">扩展点重构</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsgeneral-knowledge" href="/zh/docs/v2.7/dev/principals/general-knowledge/">一些设计上的基本常识</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsrobustness" href="/zh/docs/v2.7/dev/principals/robustness/">设计实现的健壮性</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devprincipalsintroduction" href="/zh/docs/v2.7/dev/principals/introduction/"></a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27devcontract" href="/zh/docs/v2.7/dev/contract/">公共契约</a>
        
      
      
      
        
          






<ul>
  <li>
    <a class="active" href="/zh/docs/v2.7/dev/source/" >源代码</a>
  </li>
  <ul>
    <li class="collapse show" id="zhdocsv27devsource">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourcedubbo-spi" href="/zh/docs/v2.7/dev/source/dubbo-spi/">Dubbo SPI</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourcerouter" class="active2" href="/zh/docs/v2.7/dev/source/router/">服务路由</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourceadaptive-extension" href="/zh/docs/v2.7/dev/source/adaptive-extension/">SPI 自适应拓展</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourceexport-service" href="/zh/docs/v2.7/dev/source/export-service/">服务导出</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourcerefer-service" href="/zh/docs/v2.7/dev/source/refer-service/">服务引用</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourceservice-invoking-process" href="/zh/docs/v2.7/dev/source/service-invoking-process/">服务调用过程</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourcedirectory" href="/zh/docs/v2.7/dev/source/directory/">服务目录</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourcecluster" href="/zh/docs/v2.7/dev/source/cluster/">集群</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devsourceloadbalance" href="/zh/docs/v2.7/dev/source/loadbalance/">负载均衡</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          
          
          <a id="m-zhdocsv27devrelease" href="/zh/docs/v2.7/dev/release/">版本管理</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devchecklist" href="/zh/docs/v2.7/dev/checklist/">检查列表</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devcode-smell" href="/zh/docs/v2.7/dev/code-smell/">坏味道</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devcoding" href="/zh/docs/v2.7/dev/coding/">编码约定</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27devtck" href="/zh/docs/v2.7/dev/tck/">TCK</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/admin/" >运维管理指南</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27admin">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/admin/ops/" >Dubbo Admin 运维指南</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27adminops">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopsfunctions" href="/zh/docs/v2.7/admin/ops/functions/">管理控制台运维</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopsintroduction" href="/zh/docs/v2.7/admin/ops/introduction/">Dubbo 管理控制台介绍</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopssearch" href="/zh/docs/v2.7/admin/ops/search/">服务查询和详情展示</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopstest" href="/zh/docs/v2.7/admin/ops/test/">服务测试</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopsapidocs" href="/zh/docs/v2.7/admin/ops/apidocs/">API文档&amp;测试</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopsgovernance" href="/zh/docs/v2.7/admin/ops/governance/">服务治理和配置管理</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopsskywalking" href="/zh/docs/v2.7/admin/ops/skywalking/">使用 Apache Skywalking 做分布式跟踪</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27adminopspinpoint" href="/zh/docs/v2.7/admin/ops/pinpoint/">使用 Pinpoint 做分布式跟踪</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v2.7/admin/install/" >安装手册</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv27admininstall">
      
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstalladmin-console" href="/zh/docs/v2.7/admin/install/admin-console/">管理控制台安装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstallprovider-demo" href="/zh/docs/v2.7/admin/install/provider-demo/">示例提供者安装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstallconsumer-demo" href="/zh/docs/v2.7/admin/install/consumer-demo/">示例消费者安装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstallredis" href="/zh/docs/v2.7/admin/install/redis/">Redis 注册中心安装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstallzookeeper" href="/zh/docs/v2.7/admin/install/zookeeper/">Zookeeper 注册中心安装</a>
        
      
      
      
        
          
          
          <a id="m-zhdocsv27admininstallmonitor-center" href="/zh/docs/v2.7/admin/install/monitor-center/">Simple 监控中心安装</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/v3.0/" >Dubbo 3.0</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocsv30">
      
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/contribution-guidelines/" >贡献指南</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocscontribution-guidelines">
      
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/contribution-guidelines/contributor/" >Contributor 指南</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocscontribution-guidelinescontributor">
      
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributorbecome-a-committer_dev" href="/zh/docs/contribution-guidelines/contributor/become-a-committer_dev/">成为 Committer</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributorcla-signing-guide_dev" href="/zh/docs/contribution-guidelines/contributor/cla-signing-guide_dev/">CLA 签署向导</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributornew-contributor-guide_dev" href="/zh/docs/contribution-guidelines/contributor/new-contributor-guide_dev/">新手向导</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributormailing-list-subscription-guide_dev" href="/zh/docs/contribution-guidelines/contributor/mailing-list-subscription-guide_dev/">邮件组向导</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributorreporting-security-issues_dev" href="/zh/docs/contribution-guidelines/contributor/reporting-security-issues_dev/">反馈漏洞</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributorsoftware-donation-guide_dev" href="/zh/docs/contribution-guidelines/contributor/software-donation-guide_dev/">捐献向导</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributordubbo-extension-guide_dev" href="/zh/docs/contribution-guidelines/contributor/dubbo-extension-guide_dev/">扩展 Dubbo</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescontributortest-coverage-guide_dev" href="/zh/docs/contribution-guidelines/contributor/test-coverage-guide_dev/">测试覆盖率向导</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
      
        
          






<ul>
  <li>
    <a href="/zh/docs/contribution-guidelines/committer/" >Committer 指南</a>
  </li>
  <ul>
    <li class="collapse " id="zhdocscontribution-guidelinescommitter">
      
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescommitternew-committer-guide_dev" href="/zh/docs/contribution-guidelines/committer/new-committer-guide_dev/">注册流程</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescommitterrelease-guide_dev" href="/zh/docs/contribution-guidelines/committer/release-guide_dev/">发版准备</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescommitterwebsite-guide_dev" href="/zh/docs/contribution-guidelines/committer/website-guide_dev/">网站向导</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescommitterlabel-an-issue-guide_dev" href="/zh/docs/contribution-guidelines/committer/label-an-issue-guide_dev/">问题标签</a>
        
      
      
      
        
          
          
          <a id="m-zhdocscontribution-guidelinescommitterapache-dubbo-page_dev" href="/zh/docs/contribution-guidelines/committer/apache-dubbo-page_dev/">官方主页</a>
        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

        
      
      
    </li>
  </ul>
</ul>

</div>

<script>
  $(function() {
    $("#sidebarConsoleBtn").click(function () {
      $("#sidebarContent").toggle();
    });
  });
</script>



  </div>
  <div class="col-md-2 blogDocToc">
    






<div class="td-page-meta">






<a href="https://github.com/nacos-group/nacos-group.github.io/issues/new?title=%e6%9c%8d%e5%8a%a1%e8%b7%af%e7%94%b1" target="_blank"><i class="fa fa-github fa-fw"></i> 提交文档问题</a>


<a href="https://github.com/alibaba/nacos/issues/new" target="_blank"><i class="fa fa-tasks fa-fw"></i> 提交项目问题</a>

</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#1-简介">1. 简介</a></li>
    <li><a href="#2-源码分析">2. 源码分析</a>
      <ul>
        <li><a href="#21-表达式解析">2.1 表达式解析</a></li>
        <li><a href="#22-服务路由">2.2 服务路由</a></li>
      </ul>
    </li>
    <li><a href="#3-总结">3. 总结</a></li>
  </ul>
</nav>



  </div>
  <div class="row">
    <div class="col-md-2">
    </div>
    <div class="col-md-8 blogDocContent">
      


<div class="row">
  <div class="col-md-2">
    <ul>
      
    </ul>
  </div>
  <div class="col-md-10">
    
  </div>
</div>
<div class="td-content">
  <h1>服务路由</h1>
  
  <div class="lead">本文介绍了服务路由的原理和实现细节</div>
  
  <div class="td-byline mb-4">
    <time datetime="0001-01-01" class="text-muted">0001-01-01</time>
  </div>
  
  <h2 id="1-简介">1. 简介</h2>
<p>上一篇文章分析了集群容错的第一部分 — 服务目录 Directory。服务目录在刷新 Invoker 列表的过程中，会通过 Router 进行服务路由，筛选出符合路由规则的服务提供者。在详细分析服务路由的源码之前，先来介绍一下服务路由是什么。服务路由包含一条路由规则，路由规则决定了服务消费者的调用目标，即规定了服务消费者可调用哪些服务提供者。Dubbo 目前提供了三种服务路由实现，分别为条件路由 ConditionRouter、脚本路由 ScriptRouter 和标签路由 TagRouter。其中条件路由是我们最常使用的，标签路由是一个新的实现，暂时还未发布，该实现预计会在 2.7.x 版本中发布。本篇文章将分析条件路由相关源码，脚本路由和标签路由这里就不分析了。</p>
<h2 id="2-源码分析">2. 源码分析</h2>
<p>条件路由规则由两个条件组成，分别用于对服务消费者和提供者进行匹配。比如有这样一条规则：</p>
<p><code>host = 10.20.153.10 =&gt; host = 10.20.153.11</code></p>
<p>该条规则表示 IP 为 10.20.153.10 的服务消费者<strong>只可</strong>调用 IP 为 10.20.153.11 机器上的服务，不可调用其他机器上的服务。条件路由规则的格式如下：</p>
<p><code>[服务消费者匹配条件] =&gt; [服务提供者匹配条件]</code></p>
<p>如果服务消费者匹配条件为空，表示不对服务消费者进行限制。如果服务提供者匹配条件为空，表示对某些服务消费者禁用服务。官方文档中对条件路由进行了比较详细的介绍，大家可以参考下，这里就不过多说明了。</p>
<p>条件路由实现类 ConditionRouter 在进行工作前，需要先对用户配置的路由规则进行解析，得到一系列的条件。然后再根据这些条件对服务进行路由。本章将分两节进行说明，2.1节介绍表达式解析过程。2.2 节介绍服务路由的过程。下面，我们先从表达式解析过程看起。</p>
<h3 id="21-表达式解析">2.1 表达式解析</h3>
<p>条件路由规则是一条字符串，对于 Dubbo 来说，它并不能直接理解字符串的意思，需要将其解析成内部格式才行。条件表达式的解析过程始于 ConditionRouter 的构造方法，下面一起看一下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">ConditionRouter</span><span style="color:#719e07">(</span>URL url<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#719e07">this</span><span style="color:#719e07">.</span>url <span style="color:#719e07">=</span> url<span style="color:#719e07">;</span>
    <span style="color:#586e75">// 获取 priority 和 force 配置
</span><span style="color:#586e75"></span>    <span style="color:#719e07">this</span><span style="color:#719e07">.</span>priority <span style="color:#719e07">=</span> url<span style="color:#719e07">.</span>getParameter<span style="color:#719e07">(</span>Constants<span style="color:#719e07">.</span>PRIORITY_KEY<span style="color:#719e07">,</span> 0<span style="color:#719e07">);</span>
    <span style="color:#719e07">this</span><span style="color:#719e07">.</span>force <span style="color:#719e07">=</span> url<span style="color:#719e07">.</span>getParameter<span style="color:#719e07">(</span>Constants<span style="color:#719e07">.</span>FORCE_KEY<span style="color:#719e07">,</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">);</span>
    <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 获取路由规则
</span><span style="color:#586e75"></span>        String rule <span style="color:#719e07">=</span> url<span style="color:#719e07">.</span>getParameterAndDecoded<span style="color:#719e07">(</span>Constants<span style="color:#719e07">.</span>RULE_KEY<span style="color:#719e07">);</span>
        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>rule <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> rule<span style="color:#719e07">.</span>trim<span style="color:#719e07">().</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> IllegalArgumentException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Illegal route rule!&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span>
        rule <span style="color:#719e07">=</span> rule<span style="color:#719e07">.</span>replace<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;consumer.&#34;</span><span style="color:#719e07">,</span> <span style="color:#2aa198">&#34;&#34;</span><span style="color:#719e07">).</span>replace<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;provider.&#34;</span><span style="color:#719e07">,</span> <span style="color:#2aa198">&#34;&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#586e75">// 定位 =&gt; 分隔符
</span><span style="color:#586e75"></span>        <span style="color:#dc322f">int</span> i <span style="color:#719e07">=</span> rule<span style="color:#719e07">.</span>indexOf<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;=&gt;&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#586e75">// 分别获取服务消费者和提供者匹配规则
</span><span style="color:#586e75"></span>        String whenRule <span style="color:#719e07">=</span> i <span style="color:#719e07">&lt;</span> 0 <span style="color:#719e07">?</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">:</span> rule<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>0<span style="color:#719e07">,</span> i<span style="color:#719e07">).</span>trim<span style="color:#719e07">();</span>
        String thenRule <span style="color:#719e07">=</span> i <span style="color:#719e07">&lt;</span> 0 <span style="color:#719e07">?</span> rule<span style="color:#719e07">.</span>trim<span style="color:#719e07">()</span> <span style="color:#719e07">:</span> rule<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>i <span style="color:#719e07">+</span> 2<span style="color:#719e07">).</span>trim<span style="color:#719e07">();</span>
        <span style="color:#586e75">// 解析服务消费者匹配规则
</span><span style="color:#586e75"></span>        Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> when <span style="color:#719e07">=</span> 
            StringUtils<span style="color:#719e07">.</span>isBlank<span style="color:#719e07">(</span>whenRule<span style="color:#719e07">)</span> <span style="color:#719e07">||</span> <span style="color:#2aa198">&#34;true&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>whenRule<span style="color:#719e07">)</span> 
                <span style="color:#719e07">?</span> <span style="color:#719e07">new</span> HashMap<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;()</span> <span style="color:#719e07">:</span> parseRule<span style="color:#719e07">(</span>whenRule<span style="color:#719e07">);</span>
        <span style="color:#586e75">// 解析服务提供者匹配规则
</span><span style="color:#586e75"></span>        Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> then <span style="color:#719e07">=</span> 
            StringUtils<span style="color:#719e07">.</span>isBlank<span style="color:#719e07">(</span>thenRule<span style="color:#719e07">)</span> <span style="color:#719e07">||</span> <span style="color:#2aa198">&#34;false&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>thenRule<span style="color:#719e07">)</span> 
                <span style="color:#719e07">?</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">:</span> parseRule<span style="color:#719e07">(</span>thenRule<span style="color:#719e07">);</span>
        <span style="color:#586e75">// 将解析出的匹配规则分别赋值给 whenCondition 和 thenCondition 成员变量
</span><span style="color:#586e75"></span>        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>whenCondition <span style="color:#719e07">=</span> when<span style="color:#719e07">;</span>
        <span style="color:#719e07">this</span><span style="color:#719e07">.</span>thenCondition <span style="color:#719e07">=</span> then<span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>ParseException e<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> IllegalStateException<span style="color:#719e07">(</span>e<span style="color:#719e07">.</span>getMessage<span style="color:#719e07">(),</span> e<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>如上，ConditionRouter 构造方法先是对路由规则做预处理，然后调用 parseRule 方法分别对服务提供者和消费者规则进行解析，最后将解析结果赋值给 whenCondition 和 thenCondition 成员变量。ConditionRouter 构造方法不是很复杂，这里就不多说了。下面我们把重点放在 parseRule 方法上，在详细介绍这个方法之前，我们先来看一个内部类。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">private</span> <span style="color:#268bd2">static</span> <span style="color:#268bd2">final</span> <span style="color:#268bd2">class</span> <span style="color:#268bd2">MatchPair</span> <span style="color:#719e07">{</span>
    <span style="color:#268bd2">final</span> Set<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> matches <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashSet<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;();</span>
    <span style="color:#268bd2">final</span> Set<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> mismatches <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashSet<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;();</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>MatchPair 内部包含了两个 Set 类型的成员变量，分别用于存放匹配和不匹配的条件。这个类两个成员变量会在 parseRule 方法中被用到，下面来看一下。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">private</span> <span style="color:#268bd2">static</span> Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> <span style="color:#268bd2">parseRule</span><span style="color:#719e07">(</span>String rule<span style="color:#719e07">)</span>
        <span style="color:#268bd2">throws</span> ParseException <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 定义条件映射集合
</span><span style="color:#586e75"></span>    Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> condition <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> HashMap<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;();</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>StringUtils<span style="color:#719e07">.</span>isBlank<span style="color:#719e07">(</span>rule<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> condition<span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
    MatchPair pair <span style="color:#719e07">=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
    Set<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">&gt;</span> values <span style="color:#719e07">=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">;</span>
    <span style="color:#586e75">// 通过正则表达式匹配路由规则，ROUTE_PATTERN = ([&amp;!=,]*)\s*([^&amp;!=,\s]+)
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 这个表达式看起来不是很好理解，第一个括号内的表达式用于匹配&#34;&amp;&#34;, &#34;!&#34;, &#34;=&#34; 和 &#34;,&#34; 等符号。
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 第二括号内的用于匹配英文字母，数字等字符。举个例子说明一下：
</span><span style="color:#586e75"></span>    <span style="color:#586e75">//    host = 2.2.2.2 &amp; host != 1.1.1.1 &amp; method = hello
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 匹配结果如下：
</span><span style="color:#586e75"></span>    <span style="color:#586e75">//     括号一      括号二
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 1.  null       host
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 2.   =         2.2.2.2
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 3.   &amp;         host
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 4.   !=        1.1.1.1 
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 5.   &amp;         method
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 6.   =         hello
</span><span style="color:#586e75"></span>    <span style="color:#268bd2">final</span> Matcher matcher <span style="color:#719e07">=</span> ROUTE_PATTERN<span style="color:#719e07">.</span>matcher<span style="color:#719e07">(</span>rule<span style="color:#719e07">);</span>
    <span style="color:#719e07">while</span> <span style="color:#719e07">(</span>matcher<span style="color:#719e07">.</span>find<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
       	<span style="color:#586e75">// 获取括号一内的匹配结果
</span><span style="color:#586e75"></span>        String separator <span style="color:#719e07">=</span> matcher<span style="color:#719e07">.</span>group<span style="color:#719e07">(</span>1<span style="color:#719e07">);</span>
        <span style="color:#586e75">// 获取括号二内的匹配结果
</span><span style="color:#586e75"></span>        String content <span style="color:#719e07">=</span> matcher<span style="color:#719e07">.</span>group<span style="color:#719e07">(</span>2<span style="color:#719e07">);</span>
        <span style="color:#586e75">// 分隔符为空，表示匹配的是表达式的开始部分
</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>separator <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> separator<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 创建 MatchPair 对象
</span><span style="color:#586e75"></span>            pair <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> MatchPair<span style="color:#719e07">();</span>
            <span style="color:#586e75">// 存储 &lt;匹配项, MatchPair&gt; 键值对，比如 &lt;host, MatchPair&gt;
</span><span style="color:#586e75"></span>            condition<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span>content<span style="color:#719e07">,</span> pair<span style="color:#719e07">);</span> 
        <span style="color:#719e07">}</span> 
        
        <span style="color:#586e75">// 如果分隔符为 &amp;，表明接下来也是一个条件
</span><span style="color:#586e75"></span>        <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#2aa198">&#34;&amp;&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>separator<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 尝试从 condition 获取 MatchPair
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>condition<span style="color:#719e07">.</span>get<span style="color:#719e07">(</span>content<span style="color:#719e07">)</span> <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                <span style="color:#586e75">// 未获取到 MatchPair，重新创建一个，并放入 condition 中
</span><span style="color:#586e75"></span>                pair <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> MatchPair<span style="color:#719e07">();</span>
                condition<span style="color:#719e07">.</span>put<span style="color:#719e07">(</span>content<span style="color:#719e07">,</span> pair<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
                pair <span style="color:#719e07">=</span> condition<span style="color:#719e07">.</span>get<span style="color:#719e07">(</span>content<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span> 
        
        <span style="color:#586e75">// 分隔符为 =
</span><span style="color:#586e75"></span>        <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#2aa198">&#34;=&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>separator<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>pair <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span>
                <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> ParseException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Illegal route rule ...&#34;</span><span style="color:#719e07">);</span>

            values <span style="color:#719e07">=</span> pair<span style="color:#719e07">.</span>matches<span style="color:#719e07">;</span>
            <span style="color:#586e75">// 将 content 存入到 MatchPair 的 matches 集合中
</span><span style="color:#586e75"></span>            values<span style="color:#719e07">.</span>add<span style="color:#719e07">(</span>content<span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span> 
        
        <span style="color:#586e75">//  分隔符为 != 
</span><span style="color:#586e75"></span>        <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#2aa198">&#34;!=&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>separator<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>pair <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span>
                <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> ParseException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Illegal route rule ...&#34;</span><span style="color:#719e07">);</span>

            values <span style="color:#719e07">=</span> pair<span style="color:#719e07">.</span>mismatches<span style="color:#719e07">;</span>
            <span style="color:#586e75">// 将 content 存入到 MatchPair 的 mismatches 集合中
</span><span style="color:#586e75"></span>            values<span style="color:#719e07">.</span>add<span style="color:#719e07">(</span>content<span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span>
        
        <span style="color:#586e75">// 分隔符为 ,
</span><span style="color:#586e75"></span>        <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#2aa198">&#34;,&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>separator<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>values <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> values<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span>
                <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> ParseException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Illegal route rule ...&#34;</span><span style="color:#719e07">);</span>
            <span style="color:#586e75">// 将 content 存入到上一步获取到的 values 中，可能是 matches，也可能是 mismatches
</span><span style="color:#586e75"></span>            values<span style="color:#719e07">.</span>add<span style="color:#719e07">(</span>content<span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">throw</span> <span style="color:#719e07">new</span> ParseException<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Illegal route rule ...&#34;</span><span style="color:#719e07">);</span>
        <span style="color:#719e07">}</span>
    <span style="color:#719e07">}</span>
    <span style="color:#719e07">return</span> condition<span style="color:#719e07">;</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>以上就是路由规则的解析逻辑，该逻辑由正则表达式和一个 while 循环以及数个条件分支组成。下面通过一个示例对解析逻辑进行演绎。示例为 <code> host = 2.2.2.2 &amp; host != 1.1.1.1 &amp; method = hello</code>。正则解析结果如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">    括号一      括号二
1.  null       host
2.   =         2.2.2.2
3.   &amp;         host
4.   !=        1.1.1.1
5.   &amp;         method
6.   =         hello
</code></pre></div><p>现在线程进入 while 循环：</p>
<p>第一次循环：分隔符 separator = null，content = &ldquo;host&rdquo;。此时创建 MatchPair 对象，并存入到 condition 中，condition = {&ldquo;host&rdquo;: MatchPair@123}</p>
<p>第二次循环：分隔符 separator = &ldquo;=&quot;，content = &ldquo;2.2.2.2&rdquo;，pair = MatchPair@123。此时将 2.2.2.2 放入到 MatchPair@123 对象的 matches 集合中。</p>
<p>第三次循环：分隔符 separator = &ldquo;&amp;&quot;，content = &ldquo;host&rdquo;。host 已存在于 condition 中，因此 pair = MatchPair@123。</p>
<p>第四次循环：分隔符 separator = &ldquo;!=&quot;，content = &ldquo;1.1.1.1&rdquo;，pair = MatchPair@123。此时将 1.1.1.1 放入到 MatchPair@123 对象的 mismatches 集合中。</p>
<p>第五次循环：分隔符 separator = &ldquo;&amp;&quot;，content = &ldquo;method&rdquo;。condition.get(&ldquo;method&rdquo;) = null，因此新建一个 MatchPair 对象，并放入到 condition 中。此时 condition = {&ldquo;host&rdquo;: MatchPair@123, &ldquo;method&rdquo;: MatchPair@ 456}</p>
<p>第六次循环：分隔符 separator = &ldquo;=&quot;，content = &ldquo;2.2.2.2&rdquo;，pair = MatchPair@456。此时将 hello 放入到 MatchPair@456 对象的 matches 集合中。</p>
<p>循环结束，此时 condition 的内容如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#268bd2">&#34;host&#34;</span>: {
        <span style="color:#268bd2">&#34;matches&#34;</span>: [<span style="color:#2aa198">&#34;2.2.2.2&#34;</span>],
        <span style="color:#268bd2">&#34;mismatches&#34;</span>: [<span style="color:#2aa198">&#34;1.1.1.1&#34;</span>]
    },
    <span style="color:#268bd2">&#34;method&#34;</span>: {
        <span style="color:#268bd2">&#34;matches&#34;</span>: [<span style="color:#2aa198">&#34;hello&#34;</span>],
        <span style="color:#268bd2">&#34;mismatches&#34;</span>: []
    }
}
</code></pre></div><p>路由规则的解析过程稍微有点复杂，大家可通过 ConditionRouter 的测试类对该逻辑进行测试。并且找一个表达式，对照上面的代码走一遍，加深理解。</p>
<h3 id="22-服务路由">2.2 服务路由</h3>
<p>服务路由的入口方法是 ConditionRouter 的 route 方法，该方法定义在 Router 接口中。实现代码如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;</span> List<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;</span> <span style="color:#268bd2">route</span><span style="color:#719e07">(</span>List<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;</span> invokers<span style="color:#719e07">,</span> URL url<span style="color:#719e07">,</span> Invocation invocation<span style="color:#719e07">)</span> <span style="color:#268bd2">throws</span> RpcException <span style="color:#719e07">{</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>invokers <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> invokers<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">return</span> invokers<span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
    <span style="color:#719e07">try</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 先对服务消费者条件进行匹配，如果匹配失败，表明服务消费者 url 不符合匹配规则，
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 无需进行后续匹配，直接返回 Invoker 列表即可。比如下面的规则：
</span><span style="color:#586e75"></span>        <span style="color:#586e75">//     host = 10.20.153.10 =&gt; host = 10.0.0.10
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 这条路由规则希望 IP 为 10.20.153.10 的服务消费者调用 IP 为 10.0.0.10 机器上的服务。
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 当消费者 ip 为 10.20.153.11 时，matchWhen 返回 false，表明当前这条路由规则不适用于
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 当前的服务消费者，此时无需再进行后续匹配，直接返回即可。
</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>matchWhen<span style="color:#719e07">(</span>url<span style="color:#719e07">,</span> invocation<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">return</span> invokers<span style="color:#719e07">;</span>
        <span style="color:#719e07">}</span>
        List<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;</span> result <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> ArrayList<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;();</span>
        <span style="color:#586e75">// 服务提供者匹配条件未配置，表明对指定的服务消费者禁用服务，也就是服务消费者在黑名单中
</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>thenCondition <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            logger<span style="color:#719e07">.</span>warn<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;The current consumer in the service blacklist...&#34;</span><span style="color:#719e07">);</span>
            <span style="color:#719e07">return</span> result<span style="color:#719e07">;</span>
        <span style="color:#719e07">}</span>
        <span style="color:#586e75">// 这里可以简单的把 Invoker 理解为服务提供者，现在使用服务提供者匹配规则对 
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// Invoker 列表进行匹配
</span><span style="color:#586e75"></span>        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;</span> invoker <span style="color:#719e07">:</span> invokers<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 若匹配成功，表明当前 Invoker 符合服务提供者匹配规则。
</span><span style="color:#586e75"></span>            <span style="color:#586e75">// 此时将 Invoker 添加到 result 列表中
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>matchThen<span style="color:#719e07">(</span>invoker<span style="color:#719e07">.</span>getUrl<span style="color:#719e07">(),</span> url<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                result<span style="color:#719e07">.</span>add<span style="color:#719e07">(</span>invoker<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        
        <span style="color:#586e75">// 返回匹配结果，如果 result 为空列表，且 force = true，表示强制返回空列表，
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 否则路由结果为空的路由规则将自动失效
</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>result<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">return</span> result<span style="color:#719e07">;</span>
        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>force<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            logger<span style="color:#719e07">.</span>warn<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;The route result is empty and force execute ...&#34;</span><span style="color:#719e07">);</span>
            <span style="color:#719e07">return</span> result<span style="color:#719e07">;</span>
        <span style="color:#719e07">}</span>
    <span style="color:#719e07">}</span> <span style="color:#719e07">catch</span> <span style="color:#719e07">(</span>Throwable t<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        logger<span style="color:#719e07">.</span>error<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;Failed to execute condition router rule: ...&#34;</span><span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>
    
    <span style="color:#586e75">// 原样返回，此时 force = false，表示该条路由规则失效
</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> invokers<span style="color:#719e07">;</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>route 方法先是调用 matchWhen 对服务消费者进行匹配，如果匹配失败，直接返回 Invoker 列表。如果匹配成功，再对服务提供者进行匹配，匹配逻辑封装在了 matchThen 方法中。下面来看一下这两个方法的逻辑：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#dc322f">boolean</span> <span style="color:#268bd2">matchWhen</span><span style="color:#719e07">(</span>URL url<span style="color:#719e07">,</span> Invocation invocation<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 服务消费者条件为 null 或空，均返回 true，比如：
</span><span style="color:#586e75"></span>    <span style="color:#586e75">//     =&gt; host != 172.22.3.91
</span><span style="color:#586e75"></span>    <span style="color:#586e75">// 表示所有的服务消费者都不得调用 IP 为 172.22.3.91 的机器上的服务
</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> whenCondition <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> whenCondition<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">()</span> 
        <span style="color:#719e07">||</span> matchCondition<span style="color:#719e07">(</span>whenCondition<span style="color:#719e07">,</span> url<span style="color:#719e07">,</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">,</span> invocation<span style="color:#719e07">);</span>  <span style="color:#586e75">// 进行条件匹配
</span><span style="color:#586e75"></span><span style="color:#719e07">}</span>

<span style="color:#268bd2">private</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">matchThen</span><span style="color:#719e07">(</span>URL url<span style="color:#719e07">,</span> URL param<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 服务提供者条件为 null 或空，表示禁用服务
</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> <span style="color:#719e07">!(</span>thenCondition <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> thenCondition<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> 
        <span style="color:#719e07">&amp;&amp;</span> matchCondition<span style="color:#719e07">(</span>thenCondition<span style="color:#719e07">,</span> url<span style="color:#719e07">,</span> param<span style="color:#719e07">,</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">);</span>  <span style="color:#586e75">// 进行条件匹配
</span><span style="color:#586e75"></span><span style="color:#719e07">}</span>
</code></pre></div><p>这两个方法长的有点像，不过逻辑上还是有差别的，大家注意看。这两个方法均调用了 matchCondition 方法，但它们所传入的参数是不同的。这个需要特别注意一下，不然后面的逻辑不好弄懂。下面我们对这几个参数进行溯源。matchWhen 方法向 matchCondition 方法传入的参数为 [whenCondition, url, null, invocation]，第一个参数 whenCondition 为服务消费者匹配条件，这个前面分析过。第二个参数 url 源自 route 方法的参数列表，该参数由外部类调用 route 方法时传入。比如：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">private</span> List<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;</span> <span style="color:#268bd2">route</span><span style="color:#719e07">(</span>List<span style="color:#719e07">&lt;</span>Invoker<span style="color:#719e07">&lt;</span>T<span style="color:#719e07">&gt;&gt;</span> invokers<span style="color:#719e07">,</span> String method<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    Invocation invocation <span style="color:#719e07">=</span> <span style="color:#719e07">new</span> RpcInvocation<span style="color:#719e07">(</span>method<span style="color:#719e07">,</span> <span style="color:#719e07">new</span> Class<span style="color:#719e07">&lt;?&gt;[</span>0<span style="color:#719e07">],</span> <span style="color:#719e07">new</span> Object<span style="color:#719e07">[</span>0<span style="color:#719e07">]);</span>
    List<span style="color:#719e07">&lt;</span>Router<span style="color:#719e07">&gt;</span> routers <span style="color:#719e07">=</span> getRouters<span style="color:#719e07">();</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>routers <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>Router router <span style="color:#719e07">:</span> routers<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>router<span style="color:#719e07">.</span>getUrl<span style="color:#719e07">()</span> <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                <span style="color:#586e75">// 注意第二个参数
</span><span style="color:#586e75"></span>                invokers <span style="color:#719e07">=</span> router<span style="color:#719e07">.</span>route<span style="color:#719e07">(</span>invokers<span style="color:#719e07">,</span> getConsumerUrl<span style="color:#719e07">(),</span> invocation<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
    <span style="color:#719e07">}</span>
    <span style="color:#719e07">return</span> invokers<span style="color:#719e07">;</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>上面这段代码来自 RegistryDirectory，第二个参数表示的是服务消费者 url。matchCondition 的 invocation 参数也是从这里传入的。</p>
<p>接下来再来看看 matchThen 向 matchCondition 方法传入的参数 [thenCondition, url, param, null]。第一个参数不用解释了。第二个和第三个参数来自 matchThen 方法的参数列表，这两个参数分别为服务提供者 url 和服务消费者 url。搞清楚这些参数来源后，接下来就可以分析 matchCondition 方法了。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">private</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">matchCondition</span><span style="color:#719e07">(</span>Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> condition<span style="color:#719e07">,</span> URL url<span style="color:#719e07">,</span> URL param<span style="color:#719e07">,</span> Invocation invocation<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 将服务提供者或消费者 url 转成 Map
</span><span style="color:#586e75"></span>    Map<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> String<span style="color:#719e07">&gt;</span> sample <span style="color:#719e07">=</span> url<span style="color:#719e07">.</span>toMap<span style="color:#719e07">();</span>
    <span style="color:#dc322f">boolean</span> result <span style="color:#719e07">=</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
    <span style="color:#586e75">// 遍历 condition 列表
</span><span style="color:#586e75"></span>    <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>Map<span style="color:#719e07">.</span>Entry<span style="color:#719e07">&lt;</span>String<span style="color:#719e07">,</span> MatchPair<span style="color:#719e07">&gt;</span> matchPair <span style="color:#719e07">:</span> condition<span style="color:#719e07">.</span>entrySet<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 获取匹配项名称，比如 host、method 等
</span><span style="color:#586e75"></span>        String key <span style="color:#719e07">=</span> matchPair<span style="color:#719e07">.</span>getKey<span style="color:#719e07">();</span>
        String sampleValue<span style="color:#719e07">;</span>
        <span style="color:#586e75">// 如果 invocation 不为空，且 key 为 mehtod(s)，表示进行方法匹配
</span><span style="color:#586e75"></span>        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>invocation <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">(</span>Constants<span style="color:#719e07">.</span>METHOD_KEY<span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>key<span style="color:#719e07">)</span> <span style="color:#719e07">||</span> Constants<span style="color:#719e07">.</span>METHODS_KEY<span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>key<span style="color:#719e07">)))</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 从 invocation 获取被调用方法的名称
</span><span style="color:#586e75"></span>            sampleValue <span style="color:#719e07">=</span> invocation<span style="color:#719e07">.</span>getMethodName<span style="color:#719e07">();</span>
        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 从服务提供者或消费者 url 中获取指定字段值，比如 host、application 等
</span><span style="color:#586e75"></span>            sampleValue <span style="color:#719e07">=</span> sample<span style="color:#719e07">.</span>get<span style="color:#719e07">(</span>key<span style="color:#719e07">);</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>sampleValue <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
                <span style="color:#586e75">// 尝试通过 default.xxx 获取相应的值
</span><span style="color:#586e75"></span>                sampleValue <span style="color:#719e07">=</span> sample<span style="color:#719e07">.</span>get<span style="color:#719e07">(</span>Constants<span style="color:#719e07">.</span>DEFAULT_KEY_PREFIX <span style="color:#719e07">+</span> key<span style="color:#719e07">);</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        
        <span style="color:#586e75">// --------------------✨ 分割线 ✨-------------------- //
</span><span style="color:#586e75"></span>        
        <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>sampleValue <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span><span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 调用 MatchPair 的 isMatch 方法进行匹配
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>matchPair<span style="color:#719e07">.</span>getValue<span style="color:#719e07">().</span>isMatch<span style="color:#719e07">(</span>sampleValue<span style="color:#719e07">,</span> param<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                <span style="color:#586e75">// 只要有一个规则匹配失败，立即返回 false 结束方法逻辑
</span><span style="color:#586e75"></span>                <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
                result <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// sampleValue 为空，表明服务提供者或消费者 url 中不包含相关字段。此时如果 
</span><span style="color:#586e75"></span>            <span style="color:#586e75">// MatchPair 的 matches 不为空，表示匹配失败，返回 false。比如我们有这样
</span><span style="color:#586e75"></span>            <span style="color:#586e75">// 一条匹配条件 loadbalance = random，假设 url 中并不包含 loadbalance 参数，
</span><span style="color:#586e75"></span>            <span style="color:#586e75">// 此时 sampleValue = null。既然路由规则里限制了 loadbalance 必须为 random，
</span><span style="color:#586e75"></span>            <span style="color:#586e75">// 但 sampleValue = null，明显不符合规则，因此返回 false
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>matchPair<span style="color:#719e07">.</span>getValue<span style="color:#719e07">().</span>matches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span> <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
                result <span style="color:#719e07">=</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
    <span style="color:#719e07">}</span>
    <span style="color:#719e07">return</span> result<span style="color:#719e07">;</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>如上，matchCondition 方法看起来有点复杂，这里简单说明一下。分割线以上的代码实际上用于获取 sampleValue 的值，分割线以下才是进行条件匹配。条件匹配调用的逻辑封装在 isMatch 中，代码如下：</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">private</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">isMatch</span><span style="color:#719e07">(</span>String value<span style="color:#719e07">,</span> URL param<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 情况一：matches 非空，mismatches 为空
</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>matches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">()</span> <span style="color:#719e07">&amp;&amp;</span> mismatches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 遍历 matches 集合，检测入参 value 是否能被 matches 集合元素匹配到。
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 举个例子，如果 value = 10.20.153.11，matches = [10.20.153.*],
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 此时 isMatchGlobPattern 方法返回 true
</span><span style="color:#586e75"></span>        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>String match <span style="color:#719e07">:</span> matches<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>UrlUtils<span style="color:#719e07">.</span>isMatchGlobPattern<span style="color:#719e07">(</span>match<span style="color:#719e07">,</span> value<span style="color:#719e07">,</span> param<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">return</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        
        <span style="color:#586e75">// 如果所有匹配项都无法匹配到入参，则返回 false
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>

    <span style="color:#586e75">// 情况二：matches 为空，mismatches 非空
</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>mismatches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">()</span> <span style="color:#719e07">&amp;&amp;</span> matches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>String mismatch <span style="color:#719e07">:</span> mismatches<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 只要入参被 mismatches 集合中的任意一个元素匹配到，就返回 false
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>UrlUtils<span style="color:#719e07">.</span>isMatchGlobPattern<span style="color:#719e07">(</span>mismatch<span style="color:#719e07">,</span> value<span style="color:#719e07">,</span> param<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        <span style="color:#586e75">// mismatches 集合中所有元素都无法匹配到入参，此时返回 true
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>

    <span style="color:#586e75">// 情况三：matches 非空，mismatches 非空
</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> <span style="color:#719e07">(!</span>matches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">()</span> <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">!</span>mismatches<span style="color:#719e07">.</span>isEmpty<span style="color:#719e07">())</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// matches 和 mismatches 均为非空，此时优先使用 mismatches 集合元素对入参进行匹配。
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// 只要 mismatches 集合中任意一个元素与入参匹配成功，就立即返回 false，结束方法逻辑
</span><span style="color:#586e75"></span>        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>String mismatch <span style="color:#719e07">:</span> mismatches<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>UrlUtils<span style="color:#719e07">.</span>isMatchGlobPattern<span style="color:#719e07">(</span>mismatch<span style="color:#719e07">,</span> value<span style="color:#719e07">,</span> param<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        <span style="color:#586e75">// mismatches 集合元素无法匹配到入参，此时再使用 matches 继续匹配
</span><span style="color:#586e75"></span>        <span style="color:#719e07">for</span> <span style="color:#719e07">(</span>String match <span style="color:#719e07">:</span> matches<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
            <span style="color:#586e75">// 只要 matches 集合中任意一个元素与入参匹配成功，就立即返回 true
</span><span style="color:#586e75"></span>            <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>UrlUtils<span style="color:#719e07">.</span>isMatchGlobPattern<span style="color:#719e07">(</span>match<span style="color:#719e07">,</span> value<span style="color:#719e07">,</span> param<span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
                <span style="color:#719e07">return</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
            <span style="color:#719e07">}</span>
        <span style="color:#719e07">}</span>
        
        <span style="color:#586e75">// 全部失配，则返回 false
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">}</span>
    
    <span style="color:#586e75">// 情况四：matches 和 mismatches 均为空，此时返回 false
</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>isMatch 方法逻辑比较清晰，由三个条件分支组成，用于处理四种情况。这里对四种情况下的匹配逻辑进行简单的总结，如下：</p>
<table>
<thead>
<tr>
<th></th>
<th>条件</th>
<th>过程</th>
</tr>
</thead>
<tbody>
<tr>
<td>情况一</td>
<td>matches 非空，mismatches 为空</td>
<td>遍历 matches 集合元素，并与入参进行匹配。只要有一个元素成功匹配入参，即可返回 true。若全部失配，则返回 false。</td>
</tr>
<tr>
<td>情况二</td>
<td>matches 为空，mismatches 非空</td>
<td>遍历 mismatches 集合元素，并与入参进行匹配。只要有一个元素成功匹配入参，立即 false。若全部失配，则返回 true。</td>
</tr>
<tr>
<td>情况三</td>
<td>matches 非空，mismatches 非空</td>
<td>优先使用 mismatches 集合元素对入参进行匹配，只要任一元素与入参匹配成功，就立即返回 false，结束方法逻辑。否则再使用 matches 中的集合元素进行匹配，只要有任意一个元素匹配成功，即可返回 true。若全部失配，则返回 false</td>
</tr>
<tr>
<td>情况四</td>
<td>matches 为空，mismatches 为空</td>
<td>直接返回 false</td>
</tr>
</tbody>
</table>
<p>isMatch 方法是通过 UrlUtils 的 isMatchGlobPattern 方法进行匹配，因此下面我们再来看看 isMatchGlobPattern 方法的逻辑。</p>
<div class="highlight"><pre style="color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">isMatchGlobPattern</span><span style="color:#719e07">(</span>String pattern<span style="color:#719e07">,</span> String value<span style="color:#719e07">,</span> URL param<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>param <span style="color:#719e07">!=</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">&amp;&amp;</span> pattern<span style="color:#719e07">.</span>startsWith<span style="color:#719e07">(</span><span style="color:#2aa198">&#34;$&#34;</span><span style="color:#719e07">))</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 引用服务消费者参数，param 参数为服务消费者 url
</span><span style="color:#586e75"></span>        pattern <span style="color:#719e07">=</span> param<span style="color:#719e07">.</span>getRawParameter<span style="color:#719e07">(</span>pattern<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>1<span style="color:#719e07">));</span>
    <span style="color:#719e07">}</span>
    <span style="color:#586e75">// 调用重载方法继续比较
</span><span style="color:#586e75"></span>    <span style="color:#719e07">return</span> isMatchGlobPattern<span style="color:#719e07">(</span>pattern<span style="color:#719e07">,</span> value<span style="color:#719e07">);</span>
<span style="color:#719e07">}</span>

<span style="color:#268bd2">public</span> <span style="color:#268bd2">static</span> <span style="color:#dc322f">boolean</span> <span style="color:#268bd2">isMatchGlobPattern</span><span style="color:#719e07">(</span>String pattern<span style="color:#719e07">,</span> String value<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
    <span style="color:#586e75">// 对 * 通配符提供支持
</span><span style="color:#586e75"></span>    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span><span style="color:#2aa198">&#34;*&#34;</span><span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>pattern<span style="color:#719e07">))</span>
        <span style="color:#586e75">// 匹配规则为通配符 *，直接返回 true 即可
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">((</span>pattern <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> pattern<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">)</span>
            <span style="color:#719e07">&amp;&amp;</span> <span style="color:#719e07">(</span>value <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> value<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">))</span>
        <span style="color:#586e75">// pattern 和 value 均为空，此时可认为两者相等，返回 true
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">true</span><span style="color:#719e07">;</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">((</span>pattern <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> pattern<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">)</span>
            <span style="color:#719e07">||</span> <span style="color:#719e07">(</span>value <span style="color:#719e07">==</span> <span style="color:#cb4b16">null</span> <span style="color:#719e07">||</span> value<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">==</span> 0<span style="color:#719e07">))</span>
        <span style="color:#586e75">// pattern 和 value 其中有一个为空，表明两者不相等，返回 false
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> <span style="color:#cb4b16">false</span><span style="color:#719e07">;</span>

    <span style="color:#586e75">// 定位 * 通配符位置
</span><span style="color:#586e75"></span>    <span style="color:#dc322f">int</span> i <span style="color:#719e07">=</span> pattern<span style="color:#719e07">.</span>lastIndexOf<span style="color:#719e07">(</span><span style="color:#2aa198">&#39;*&#39;</span><span style="color:#719e07">);</span>
    <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>i <span style="color:#719e07">==</span> <span style="color:#719e07">-</span>1<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 匹配规则中不包含通配符，此时直接比较 value 和 pattern 是否相等即可，并返回比较结果
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> value<span style="color:#719e07">.</span>equals<span style="color:#719e07">(</span>pattern<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>
    <span style="color:#586e75">// 通配符 &#34;*&#34; 在匹配规则尾部，比如 10.0.21.*
</span><span style="color:#586e75"></span>    <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>i <span style="color:#719e07">==</span> pattern<span style="color:#719e07">.</span>length<span style="color:#719e07">()</span> <span style="color:#719e07">-</span> 1<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 检测 value 是否以“不含通配符的匹配规则”开头，并返回结果。比如:
</span><span style="color:#586e75"></span>        <span style="color:#586e75">// pattern = 10.0.21.*，value = 10.0.21.12，此时返回 true
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> value<span style="color:#719e07">.</span>startsWith<span style="color:#719e07">(</span>pattern<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>0<span style="color:#719e07">,</span> i<span style="color:#719e07">));</span>
    <span style="color:#719e07">}</span>
    <span style="color:#586e75">// 通配符 &#34;*&#34; 在匹配规则头部
</span><span style="color:#586e75"></span>    <span style="color:#719e07">else</span> <span style="color:#719e07">if</span> <span style="color:#719e07">(</span>i <span style="color:#719e07">==</span> 0<span style="color:#719e07">)</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 检测 value 是否以“不含通配符的匹配规则”结尾，并返回结果
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> value<span style="color:#719e07">.</span>endsWith<span style="color:#719e07">(</span>pattern<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>i <span style="color:#719e07">+</span> 1<span style="color:#719e07">));</span>
    <span style="color:#719e07">}</span>
    <span style="color:#586e75">// 通配符 &#34;*&#34; 在匹配规则中间位置
</span><span style="color:#586e75"></span>    <span style="color:#719e07">else</span> <span style="color:#719e07">{</span>
        <span style="color:#586e75">// 通过通配符将 pattern 分成两半，得到 prefix 和 suffix
</span><span style="color:#586e75"></span>        String prefix <span style="color:#719e07">=</span> pattern<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>0<span style="color:#719e07">,</span> i<span style="color:#719e07">);</span>
        String suffix <span style="color:#719e07">=</span> pattern<span style="color:#719e07">.</span>substring<span style="color:#719e07">(</span>i <span style="color:#719e07">+</span> 1<span style="color:#719e07">);</span>
        <span style="color:#586e75">// 检测 value 是否以 prefix 开头，且以 suffix 结尾，并返回结果
</span><span style="color:#586e75"></span>        <span style="color:#719e07">return</span> value<span style="color:#719e07">.</span>startsWith<span style="color:#719e07">(</span>prefix<span style="color:#719e07">)</span> <span style="color:#719e07">&amp;&amp;</span> value<span style="color:#719e07">.</span>endsWith<span style="color:#719e07">(</span>suffix<span style="color:#719e07">);</span>
    <span style="color:#719e07">}</span>
<span style="color:#719e07">}</span>
</code></pre></div><p>以上就是 isMatchGlobPattern 两个重载方法的全部逻辑，这两个方法分别对普通的匹配过程，以及”引用消费者参数“和通配符匹配等特性提供了支持。这两个方法的逻辑不是很复杂，且代码中也进行了比较详细的注释，因此就不多说了。</p>
<h2 id="3-总结">3. 总结</h2>
<p>本篇文章对条件路由的表达式解析和服务路由过程进行了较为细致的分析。总的来说，条件路由的代码还是有一些复杂的，需要静下心来看。在阅读条件路由代码的过程中，要多调试。一般的框架都会有单元测试，Dubbo 也不例外，因此大家可以直接通过 ConditionRouterTest 对条件路由进行调试，无需重头构建测试用例。</p>

  
  
</div>


    </div>
    <div class="col-md-2">
    </div>
  </div>
  
</section>

  

<footer id="footer" role="contentinfo">
  <div class="container">
    <img src="/images/nacos_gray.png"/>
    <div class="row">
      <div class="col-md-6"><h3>愿景</h3>
        <p>Nacos 通过提供简单易用的动态服务发现、服务配置、服务共享与管理等服务基础设施，帮助用户在云原
            生时代，在私有云、混合云或者公有云等所有云环境中，更好的构建、交付、管理自己的微服务平台，更快的复用和组合业务服务，
            更快的交付商业创新的价值，从而为用户赢得市场。</p></div>
      <div class="col-md-3">
        <dl>
          <dt>文档</dt>
          
          <dd><a href="/en-us/docs/what-is-nacos.html" target="_self">概览</a></dd>
          
          <dd><a href="/en-us/docs/quick-start.html" target="_self">快速开始</a></dd>
          
          <dd><a href="/en-us/docs/contributing.html" target="_self">开发者指南</a></dd>
          
        </dl>
      </div>
      <div class="col-md-3">
        <dl>
          <dt>资源</dt>
          
          <dd><a href="/en-us/community/index.html" target="_self">社区</a></dd>
          
          <dd><a href="https://cn.aliyun.com/product/aliware/mse?spm=nacos-website.topbar.0.0.0" target="_self">云服务 MSE</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/edas?source_type=nacos_pc_20181219" target="_self">云服务 EDAS</a></dd>
          
          <dd><a href="https://www.aliyun.com/product/ahas?source_type=nacos_pc_20190225" target="_self">云服务 AHAS</a></dd>
          
        </dl>
      </div>
    </div>
    <div class="col-md-12 text-center copyright">
      <span>© 2018 The Nacos Authors | An Alibaba Middleware (Aliware) Project</span>
    </div>
  </div>
</footer>


</body>
<script type="text/javascript">
  ;(function () {
    $('#fh5co-header').addClass('navbar-fixed-top fh5co-animated slideInDown');
    $('#nacosLogo').attr("src", "/images/nacos_colorful.png")
  }());
</script>
</html>